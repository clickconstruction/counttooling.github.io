<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClickCount — PDF Measurement & Counting Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f11;
    --surface: #17171a;
    --surface2: #1e1e22;
    --surface3: #26262c;
    --border: #2e2e36;
    --border2: #3a3a44;
    --accent: #e8c547;
    --accent2: #c9a82e;
    --text: #f0ede8;
    --text2: #9e9b96;
    --text3: #5e5c58;
    --red: #e85447;
    --blue: #4a9eff;
    --green: #47c88e;
    --purple: #a47fff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ── HEADER ── */
  header {
    height: 52px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 16px;
    flex-shrink: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'Instrument Serif', serif;
    font-size: 18px;
    color: var(--accent);
    letter-spacing: -0.02em;
    margin-right: 8px;
    white-space: nowrap;
  }

  .logo span { color: var(--text2); font-style: italic; font-size: 14px; }

  .header-divider { width: 1px; height: 24px; background: var(--border); }

  .tool-btn {
    height: 32px;
    padding: 0 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tool-btn:hover { border-color: var(--border2); color: var(--text); background: var(--surface3); }
  .tool-btn.active { background: var(--accent); border-color: var(--accent); color: #000; }
  .tool-btn.danger { color: var(--red); border-color: var(--red)33; }
  .tool-btn.danger:hover { background: var(--red)22; }

  .scale-badge {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    background: var(--accent)15;
    border: 1px solid var(--accent)33;
    border-radius: 4px;
    padding: 3px 8px;
    white-space: nowrap;
  }

  .spacer { flex: 1; }

  /* ── LAYOUT ── */
  .app-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ── LEFT SIDEBAR ── */
  .sidebar {
    width: 220px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
  }

  .sidebar-section {
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text3);
  }

  .sidebar-add {
    width: 20px; height: 20px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text3);
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .sidebar-add:hover { border-color: var(--accent); color: var(--accent); }

  /* Page list */
  .page-list { max-height: 200px; overflow-y: auto; }
  .page-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    gap: 8px;
    transition: background 0.1s;
    border-left: 2px solid transparent;
  }
  .page-item:hover { background: var(--surface2); }
  .page-item.active { background: var(--surface2); border-left-color: var(--accent); }
  .page-num {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text3);
    width: 20px;
  }
  .page-name { font-size: 12px; flex: 1; color: var(--text2); }
  .page-item.active .page-name { color: var(--text); }
  .page-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); opacity: 0.6; }

  /* Counter list */
  .counter-list { max-height: 220px; overflow-y: auto; }
  .counter-item {
    display: flex;
    align-items: center;
    padding: 7px 12px;
    gap: 8px;
    cursor: pointer;
    border-left: 2px solid transparent;
    transition: background 0.1s;
  }
  .counter-item:hover { background: var(--surface2); }
  .counter-item.active { background: var(--surface2); border-left-color: var(--accent); }
  .counter-icon { font-size: 14px; width: 20px; text-align: center; display: inline-flex; align-items: center; }
  .counter-icon svg { flex-shrink: 0; }
  .counter-swatch {
    width: 10px;
    height: 10px;
    border-radius: 2px;
    flex-shrink: 0;
    border: 1px solid rgba(0,0,0,0.15);
    cursor: pointer;
  }
  .counter-color-picker {
    position: fixed;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 6px;
    z-index: 500;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    max-width: 120px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  }
  .counter-color-picker .color-swatch {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    flex-shrink: 0;
  }
  .counter-color-picker .color-swatch:hover { transform: scale(1.1); }
  .counter-color-picker .color-swatch.selected { border-color: var(--text); }
  .counter-info { flex: 1; min-width: 0; }
  .counter-name { font-size: 12px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .counter-item.active .counter-name { color: var(--text); }
  .counter-count {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    background: var(--accent)15;
    border-radius: 3px;
    padding: 1px 5px;
  }

  /* Line type list */
  .line-type-list { max-height: 140px; overflow-y: auto; }
  .line-type-item {
    display: flex;
    align-items: center;
    padding: 7px 12px;
    gap: 8px;
    cursor: pointer;
    border-left: 2px solid transparent;
    transition: background 0.1s;
  }
  .line-type-item:hover { background: var(--surface2); }
  .line-type-item.active { background: var(--surface2); border-left-color: var(--accent); }
  .line-type-swatch { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
  .line-type-name { font-size: 12px; color: var(--text2); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .line-type-item.active .line-type-name { color: var(--text); }
  .line-type-stats { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text3); }

  /* Polyline list */
  .poly-list { max-height: 180px; overflow-y: auto; flex: 1; overflow-y: auto; }
  .poly-item {
    display: flex;
    align-items: center;
    padding: 7px 12px;
    gap: 8px;
    cursor: pointer;
    border-left: 2px solid transparent;
    transition: background 0.1s;
  }
  .poly-item:hover { background: var(--surface2); }
  .poly-item.active { background: var(--surface2); border-left-color: var(--accent); }
  .poly-swatch { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
  .poly-name { font-size: 12px; color: var(--text2); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .poly-dist {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text3);
  }

  /* Summary section */
  .summary-section {
    margin-top: auto;
    border-top: 1px solid var(--border);
    padding: 10px 12px;
  }
  .summary-title {
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 8px;
    font-weight: 600;
  }
  .summary-row {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text2);
    padding: 2px 0;
  }
  .summary-row span:last-child { font-family: 'DM Mono', monospace; color: var(--accent); }

  /* ── CANVAS AREA ── */
  .canvas-area {
    flex: 1;
    position: relative;
    overflow: hidden;
    touch-action: none;
    background: #0a0a0c;
    background-image: radial-gradient(circle at 1px 1px, #1e1e22 1px, transparent 0);
    background-size: 24px 24px;
  }

  #canvas-wrapper {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 0 1px var(--border), 0 24px 80px rgba(0,0,0,0.6);
  }

  #pdf-canvas, #pdf-canvas-buffer {
    display: block;
    background: white;
  }
  #pdf-canvas.pdf-hidden,
  #pdf-canvas-buffer.pdf-hidden { display: none; }

  #annotation-canvas {
    position: absolute;
    top: 0; left: 0;
    pointer-events: all;
  }

  .empty-state {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }
  .empty-state h2 {
    font-family: 'Instrument Serif', serif;
    font-size: 28px;
    color: var(--text3);
    margin-bottom: 8px;
  }
  .empty-state p { font-size: 13px; color: var(--text3); margin-bottom: 20px; }
  .upload-big {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: var(--accent);
    color: #000;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    border: none;
    font-family: 'DM Sans', sans-serif;
    transition: background 0.15s;
  }
  .upload-big:hover { background: var(--accent2); }

  /* Zoom controls */
  .zoom-controls {
    position: absolute;
    bottom: 16px;
    right: 16px;
    display: flex;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px;
  }
  .zoom-btn {
    width: 28px; height: 28px;
    border-radius: 5px;
    border: none;
    background: transparent;
    color: var(--text2);
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.1s;
  }
  .zoom-btn:hover { background: var(--surface3); color: var(--text); }
  .zoom-level { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text3); padding: 0 6px; display: flex; align-items: center; }

  /* Cursor HUD */
  #hud {
    position: absolute;
    pointer-events: none;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 4px 8px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    display: none;
    white-space: nowrap;
    z-index: 50;
  }

  /* ── MODALS ── */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    min-width: 360px;
    max-width: 440px;
    width: 90vw;
    transform: translateY(8px);
    transition: transform 0.2s;
    box-shadow: 0 24px 80px rgba(0,0,0,0.5);
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-title {
    font-family: 'Instrument Serif', serif;
    font-size: 22px;
    margin-bottom: 4px;
    color: var(--text);
  }
  .modal-subtitle { font-size: 12px; color: var(--text3); margin-bottom: 20px; }

  .form-group { margin-bottom: 16px; }
  .form-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text3); margin-bottom: 6px; display: block; }

  .form-input {
    width: 100%;
    height: 38px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    padding: 0 12px;
    outline: none;
    transition: border-color 0.15s;
  }
  .form-input:focus { border-color: var(--accent); }

  .form-row { display: flex; gap: 8px; }
  .form-row .form-input { flex: 1; }

  select.form-input { cursor: pointer; }

  .icon-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 4px;
  }
  .icon-opt {
    aspect-ratio: 1;
    border-radius: 6px;
    border: 2px solid transparent;
    background: var(--surface2);
    cursor: pointer;
    font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.1s;
  }
  .icon-opt:hover { border-color: var(--border2); }
  .icon-opt.selected { border-color: var(--accent); background: var(--accent)15; }

  .color-row { display: flex; gap: 6px; align-items: center; }
  .color-swatch {
    width: 28px; height: 28px;
    border-radius: 6px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: transform 0.1s;
  }
  .color-swatch:hover { transform: scale(1.1); }
  .color-swatch.selected { border-color: var(--text); }

  .scale-preview {
    background: var(--surface2);
    border-radius: 6px;
    padding: 10px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--accent);
    margin-top: 8px;
    min-height: 34px;
    display: flex;
    align-items: center;
  }

  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

  .btn-secondary {
    height: 36px;
    padding: 0 16px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.15s;
  }
  .btn-secondary:hover { background: var(--surface2); color: var(--text); }

  .btn-primary {
    height: 36px;
    padding: 0 20px;
    border-radius: 6px;
    border: none;
    background: var(--accent);
    color: #000;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    transition: background 0.15s;
  }
  .btn-primary:hover { background: var(--accent2); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

  /* scrollbars */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  /* ── PAGE NAV ── */
  .page-nav {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 10px;
  }
  .page-nav button {
    width: 28px; height: 28px;
    border-radius: 5px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text2);
    cursor: pointer;
    font-size: 12px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.1s;
  }
  .page-nav button:hover:not(:disabled) { background: var(--surface3); color: var(--text); }
  .page-nav button:disabled { opacity: 0.3; cursor: not-allowed; }
  .page-nav span {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text3);
    min-width: 60px;
    text-align: center;
  }

  /* ── CONTEXT MENU ── */
  .ctx-menu {
    position: fixed;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 4px;
    z-index: 500;
    min-width: 140px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    display: none;
  }
  .ctx-item {
    padding: 7px 12px;
    font-size: 12px;
    color: var(--text2);
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.1s;
  }
  .ctx-item:hover { background: var(--surface3); color: var(--text); }
  .ctx-item.danger { color: var(--red); }
  .ctx-item.danger:hover { background: var(--red)15; }

  /* ── STATUS BAR ── */
  .status-bar {
    height: 24px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 16px;
    flex-shrink: 0;
  }
  .status-item {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text3);
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .status-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); }

  /* tool mode cursor */
  .mode-scale #annotation-canvas,
  .mode-line #annotation-canvas,
  .mode-polyline #annotation-canvas,
  .mode-counter #annotation-canvas { cursor: crosshair; }

  .mode-edit_poly #annotation-canvas { cursor: default; }
  .mode-edit_poly.dragging #annotation-canvas { cursor: grabbing; }

  /* Pan mode cursor */
  .canvas-area.mode-pan { cursor: grab; }
  .canvas-area.mode-pan.panning { cursor: grabbing; }

  /* Edit polyline button in sidebar */
  .edit-poly-btn {
    width: 20px; height: 20px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text3);
    cursor: pointer;
    font-size: 12px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
    margin-left: auto;
  }
  .edit-poly-btn:hover { border-color: var(--accent); color: var(--accent); }

  .inline-rename-input { outline: none; min-width: 60px; }
  .page-name, .counter-name, .line-type-name, .poly-name { cursor: text; }

  /* Done editing button in header */
  #btn-done-edit {
    background: var(--green);
    border-color: var(--green);
    color: #000;
    font-weight: 600;
    display: none;
  }
  #btn-done-edit:hover { opacity: 0.85; }

  /* Tooltip */
  [title] { position: relative; }
</style>
</head>
<body>

<!-- ═══ HEADER ═══ -->
<header>
  <div class="logo">ClickCount</div>
  <div class="header-divider"></div>

  <button class="tool-btn" id="btn-upload" onclick="document.getElementById('file-input').click()">
    ↑ Upload PDF
  </button>
  <input type="file" id="file-input" accept=".pdf" style="display:none" multiple>

  <div class="header-divider"></div>

  <button class="tool-btn" id="btn-scale" onclick="startScaleMode()">
    ◎ Set Scale
  </button>

  <div id="scale-display" class="scale-badge" style="display:none"></div>

  <div class="header-divider"></div>

  <button class="tool-btn" id="btn-line" onclick="startLineMode()" title="Draw a single measurement line">
    ╱ Quick Line
  </button>

  <button class="tool-btn" id="btn-polyline" onclick="openPolylineModal()" title="Draw a multi-segment polyline">
    ↗ Polyline
  </button>

  <button class="tool-btn" id="btn-counter" onclick="openCounterModal()" title="Add a new counter type">
    ⊕ Counter
  </button>

  <button class="tool-btn" id="btn-done-edit" onclick="exitEditMode(true)">✓ Done Editing</button>

  <div class="spacer"></div>

  <button class="tool-btn" id="btn-export" onclick="exportProject()">↓ Export</button>
  <button class="tool-btn" onclick="document.getElementById('import-input').click()">↑ Import</button>
  <input type="file" id="import-input" accept=".json" style="display:none" onchange="importProject(event)">

  <div class="header-divider"></div>
  <button class="tool-btn danger" onclick="clearPage()">✕ Clear Page</button>
</header>

<!-- ═══ BODY ═══ -->
<div class="app-body">

  <!-- ── LEFT SIDEBAR ── -->
  <div class="sidebar">

    <!-- Pages -->
    <div class="sidebar-section">
      <div class="sidebar-header">
        Pages
        <button class="sidebar-add" onclick="document.getElementById('file-input').click()" title="Add more PDFs">+</button>
      </div>
      <div class="page-list" id="page-list"></div>
    </div>

    <!-- Counters -->
    <div class="sidebar-section">
      <div class="sidebar-header">
        Counters
        <button class="sidebar-add" onclick="openCounterModal()" title="New counter">+</button>
      </div>
      <div class="counter-list" id="counter-list"></div>
    </div>

    <!-- Line Types -->
    <div class="sidebar-section">
      <div class="sidebar-header">
        Line Types
        <button class="sidebar-add" onclick="openLineTypeModal()" title="New line type">+</button>
      </div>
      <div class="line-type-list" id="line-type-list"></div>
    </div>

    <!-- Polylines -->
    <div class="sidebar-section" style="flex:1; min-height:0; display:flex; flex-direction:column; overflow:hidden">
      <div class="sidebar-header">
        Lines
        <button class="sidebar-add" onclick="openPolylineModal()" title="New polyline">+</button>
      </div>
      <div class="poly-list" id="poly-list"></div>
    </div>

    <!-- Summary -->
    <div class="summary-section" id="summary-section" style="display:none">
      <div class="summary-title">Page Summary</div>
      <div id="summary-content"></div>
    </div>

    <div class="sidebar-section" style="margin-top:auto; padding-top:12px; border-top:1px solid var(--surface2)">
      <button class="btn-primary" style="width:100%" onclick="printReport()">Print Report</button>
    </div>

  </div>

  <!-- ── CANVAS AREA ── -->
  <div class="canvas-area" id="canvas-area">

    <div class="empty-state" id="empty-state">
      <h2>No document loaded</h2>
      <p>Upload a PDF to get started</p>
      <button class="upload-big" onclick="document.getElementById('file-input').click()">
        ↑ Upload PDF
      </button>
    </div>

    <div id="canvas-wrapper" style="display:none">
      <canvas id="pdf-canvas"></canvas>
      <canvas id="pdf-canvas-buffer" class="pdf-hidden"></canvas>
      <canvas id="annotation-canvas"></canvas>
    </div>

    <div id="hud"></div>

    <!-- Page nav -->
    <div class="page-nav" id="page-nav" style="display:none">
      <button id="nav-prev" onclick="gotoPage(state.currentPage - 1)">‹</button>
      <span id="nav-label">Page 1 of 1</span>
      <button id="nav-next" onclick="gotoPage(state.currentPage + 1)">›</button>
    </div>

    <!-- Zoom controls -->
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="adjustZoom(-0.25)">−</button>
      <div class="zoom-level" id="zoom-label">100%</div>
      <button class="zoom-btn" onclick="adjustZoom(0.25)">+</button>
      <button class="zoom-btn" onclick="fitToView()" title="Fit to view">⊡</button>
    </div>

  </div>

</div>

<!-- Status bar -->
<div class="status-bar">
  <div class="status-item"><div class="status-dot"></div> Ready</div>
  <div class="status-item" id="status-mode">No tool active</div>
  <div class="status-item" id="status-coords"></div>
</div>

<!-- Context menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item danger" id="ctx-delete" onclick="contextDelete()">Delete</div>
  <div class="ctx-item" id="ctx-close-poly" onclick="contextClosePoly()" style="display:none">Close Polyline</div>
</div>

<!-- Counter color picker popover -->
<div class="counter-color-picker" id="counter-color-picker" style="display:none"></div>

<!-- ════════════════════════════════════════
     MODALS
════════════════════════════════════════ -->

<!-- Scale Modal -->
<div class="modal-overlay" id="modal-scale">
  <div class="modal">
    <div class="modal-title">Set Drawing Scale</div>
    <div class="modal-subtitle" id="scale-px-info">You selected a line spanning — pixels.</div>
    <div class="form-group">
      <label class="form-label">This distance represents</label>
      <div class="form-row">
        <input class="form-input" type="number" id="scale-value" placeholder="e.g. 25" min="0.001" step="any">
        <select class="form-input" id="scale-unit" style="flex: 0 0 90px">
          <option value="ft">ft</option>
          <option value="in">in</option>
          <option value="m">m</option>
          <option value="cm">cm</option>
          <option value="yd">yd</option>
        </select>
      </div>
    </div>
    <div class="scale-preview" id="scale-preview">Enter a value above to preview scale</div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('modal-scale')">Cancel</button>
      <button class="btn-primary" id="btn-confirm-scale" onclick="confirmScale()">Set Scale</button>
    </div>
  </div>
</div>

<!-- Counter Modal -->
<div class="modal-overlay" id="modal-counter">
  <div class="modal">
    <div class="modal-title">New Counter</div>
    <div class="modal-subtitle">Create a counter type to place on the drawing</div>
    <div class="form-group">
      <label class="form-label">Name</label>
      <input class="form-input" type="text" id="counter-name" placeholder="e.g. Parking Spots">
    </div>
    <div class="form-group">
      <label class="form-label">Icon</label>
      <input class="form-input" type="text" id="icon-search" placeholder="Search icons...">
      <div class="icon-grid" id="icon-grid"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div class="color-row" id="counter-color-row"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('modal-counter')">Cancel</button>
      <button class="btn-primary" onclick="confirmCounter()">Create Counter</button>
    </div>
  </div>
</div>

<!-- Line Type Modal -->
<div class="modal-overlay" id="modal-line-type">
  <div class="modal">
    <div class="modal-title">New Line Type</div>
    <div class="modal-subtitle">Define a line type to group multiple runs</div>
    <div class="form-group">
      <label class="form-label">Name</label>
      <input class="form-input" type="text" id="line-type-name" placeholder="e.g. Conduit Run">
    </div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div class="color-row" id="line-type-color-row"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('modal-line-type')">Cancel</button>
      <button class="btn-primary" onclick="confirmLineType()">Create Line Type</button>
    </div>
  </div>
</div>

<!-- Polyline Modal -->
<div class="modal-overlay" id="modal-polyline">
  <div class="modal">
    <div class="modal-title">New Polyline</div>
    <div class="modal-subtitle">Name and style your measurement line</div>
    <div class="form-group">
      <label class="form-label">Line type</label>
      <select class="form-input" id="poly-line-type">
        <option value="">— Select —</option>
      </select>
      <button type="button" class="btn-secondary" style="margin-top:6px;font-size:11px" onclick="closeModal('modal-polyline');reopenPolylineAfterLineType=true;openLineTypeModal()">Create new line type</button>
    </div>
    <div class="form-group">
      <label class="form-label">Name</label>
      <input class="form-input" type="text" id="poly-name" placeholder="e.g. North Fence Line">
    </div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div class="color-row" id="poly-color-row"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('modal-polyline')">Cancel</button>
      <button class="btn-primary" onclick="confirmPolyline()">Start Drawing</button>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════
     APPLICATION LOGIC
════════════════════════════════════════ -->
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ─── CONSTANTS ───────────────────────────────────────────────────────────────
const WC_PATH = 'M120 64C106.7 64 96 74.7 96 88C96 101.3 106.7 112 120 112L128 112L128 260.9C126.1 262.3 124.2 263.8 122.4 265.3C106.9 278.5 96 296.9 96 319.9C96 366.8 110.3 404 133 432.4C147.2 450.1 164.1 463.7 181.5 474.2L161.6 533.9C158.3 543.7 160 554.4 166 562.7C172 571 181.7 576 192 576L448 576C458.3 576 467.9 571.1 474 562.7C480.1 554.3 481.7 543.6 478.4 533.9L458.6 474.4C476 463.9 492.9 450.3 507.1 432.6C529.8 404.2 544.1 367.1 544.1 320.1C544.1 297 533.2 278.6 517.7 265.5C515.9 264 514 262.5 512.1 261.1L512.1 112.2L520.1 112.2C533.4 112.2 544.1 101.5 544.1 88.2C544.1 74.9 533.3 64 520 64L120 64zM192 144C192 135.2 199.2 128 208 128L240 128C248.8 128 256 135.2 256 144C256 152.8 248.8 160 240 160L208 160C199.2 160 192 152.8 192 144zM320 352C231.6 352 160 337.7 160 320C160 302.3 231.6 288 320 288C408.4 288 480 302.3 480 320C480 337.7 408.4 352 320 352z';
const WF_PATH = 'M272 32L368 32C385.7 32 400 46.3 400 64C400 81.7 385.7 96 368 96L272 96C254.3 96 240 81.7 240 64C240 46.3 254.3 32 272 32zM176 208C176 172.7 204.7 144 240 144L400 144C435.3 144 464 172.7 464 208C464 232.1 450.7 253.1 431 264C450.7 274.9 464 295.9 464 320C464 344.1 450.7 365.1 431 376C450.7 386.9 464 407.9 464 432C464 456.1 450.7 477.1 431 488C450.7 498.9 464 519.9 464 544C464 579.3 435.3 608 400 608L240 608C204.7 608 176 579.3 176 544C176 519.9 189.3 498.9 209 488C189.3 477.1 176 456.1 176 432C176 407.9 189.3 386.9 209 376C189.3 365.1 176 344.1 176 320C176 295.9 189.3 274.9 209 264C189.3 253.1 176 232.1 176 208z';
const SINK_PATH = 'M352 160C352 142.3 366.3 128 384 128C401.7 128 416 142.3 416 160C416 177.7 430.3 192 448 192C465.7 192 480 177.7 480 160C480 107 437 64 384 64C331 64 288 107 288 160L288 352L224 352L224 312C224 281.1 198.9 256 168 256L120 256C106.7 256 96 266.7 96 280C96 293.3 106.7 304 120 304L168 304C172.4 304 176 307.6 176 312L176 352L96 352C78.3 352 64 366.3 64 384C64 401.7 78.3 416 96 416L96 480C96 533 139 576 192 576L448 576C501 576 544 533 544 480L544 416C561.7 416 576 401.7 576 384C576 366.3 561.7 352 544 352L464 352L464 312C464 307.6 467.6 304 472 304L528 304C541.3 304 552 293.3 552 280C552 266.7 541.3 256 528 256L472 256C441.1 256 416 281.1 416 312L416 352L352 352L352 160z';
const HOSE_BIB_PATH = 'M256 128C256 110.3 270.3 96 288 96C305.7 96 320 110.3 320 128L416 128C433.7 128 448 142.3 448 160C448 177.7 433.7 192 416 192L320 192L320 256L338.7 256C347.2 256 355.3 259.4 361.3 265.4L383.9 288L415.9 288C504.3 288 575.9 359.6 575.9 448C575.9 465.7 561.6 480 543.9 480L479.9 480C462.2 480 447.9 465.7 447.9 448C447.9 430.3 433.6 416 415.9 416L379.8 416C359.6 445 325.9 464 287.9 464C249.9 464 216.2 445 196 416L96 416C78.3 416 64 401.7 64 384L64 320C64 302.3 78.3 288 96 288L192 288L214.6 265.4C220.6 259.4 228.7 256 237.2 256L255.9 256L255.9 192L159.9 192C142.2 192 127.9 177.7 127.9 160C127.9 142.3 142.3 128 160 128L256 128z';
const SHOWER_PATH = 'M128 195.9C128 176.1 144.1 160 163.9 160C173.4 160 182.5 163.8 189.3 170.5L205.5 186.7C184.5 225.6 188.1 274.2 216.4 309.7L215 311C205.6 320.4 205.6 335.6 215 344.9C224.4 354.2 239.6 354.3 248.9 344.9L409 185C418.4 175.6 418.4 160.4 409 151.1C399.6 141.8 384.4 141.7 375.1 151.1L373.8 152.4C338.3 124.1 289.7 120.5 250.8 141.5L234.5 125.3C215.8 106.5 190.4 96 163.9 96C108.7 96 64 140.7 64 195.9L64 512C64 529.7 78.3 544 96 544C113.7 544 128 529.7 128 512L128 195.9zM320 416C337.7 416 352 401.7 352 384C352 366.3 337.7 352 320 352C302.3 352 288 366.3 288 384C288 401.7 302.3 416 320 416zM384 480C384 462.3 369.7 448 352 448C334.3 448 320 462.3 320 480C320 497.7 334.3 512 352 512C369.7 512 384 497.7 384 480zM384 352C401.7 352 416 337.7 416 320C416 302.3 401.7 288 384 288C366.3 288 352 302.3 352 320C352 337.7 366.3 352 384 352zM448 416C448 398.3 433.7 384 416 384C398.3 384 384 398.3 384 416C384 433.7 398.3 448 416 448C433.7 448 448 433.7 448 416zM448 288C465.7 288 480 273.7 480 256C480 238.3 465.7 224 448 224C430.3 224 416 238.3 416 256C416 273.7 430.3 288 448 288zM512 352C512 334.3 497.7 320 480 320C462.3 320 448 334.3 448 352C448 369.7 462.3 384 480 384C497.7 384 512 369.7 512 352zM544 320C561.7 320 576 305.7 576 288C576 270.3 561.7 256 544 256C526.3 256 512 270.3 512 288C512 305.7 526.3 320 544 320z';
const BATH_PATH = 'M160 141.3C160 134 165.9 128 173.3 128C176.8 128 180.2 129.4 182.7 131.9L197.6 146.8C194 155.9 192.1 165.7 192.1 176C192.1 195.9 199.3 214 211.3 228C206 237.2 207.3 249.1 215.1 257C224.5 266.4 239.7 266.4 249 257L353 153C362.4 143.6 362.4 128.4 353 119.1C345.2 111.2 333.2 110 324 115.3C310 103.3 291.9 96.1 272 96.1C261.7 96.1 251.8 98.1 242.8 101.6L227.9 86.6C213.4 72.1 193.7 64 173.3 64C130.6 64 96 98.6 96 141.3L96 320C78.3 320 64 334.3 64 352C64 369.7 78.3 384 96 384L96 432C96 460.4 108.4 486 128 503.6L128 544C128 561.7 142.3 576 160 576C177.7 576 192 561.7 192 544L192 528L448 528L448 544C448 561.7 462.3 576 480 576C497.7 576 512 561.7 512 544L512 503.6C531.6 486 544 460.5 544 432L544 384C561.7 384 576 369.7 576 352C576 334.3 561.7 320 544 320L160 320L160 141.3z';
const LAUNDRY_PATH = 'M224 88C224 74.7 234.7 64 248 64L328 64C341.3 64 352 74.7 352 88L352 112L360 112C373.3 112 384 122.7 384 136C384 149.3 373.3 160 360 160L216 160C202.7 160 192 149.3 192 136C192 122.7 202.7 112 216 112L224 112L224 88zM128 320C128 249.3 185.3 192 256 192L384 192C454.7 192 512 249.3 512 320L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 320zM384 320L384 416C384 433.7 398.3 448 416 448C433.7 448 448 433.7 448 416L448 320C448 302.3 433.7 288 416 288C398.3 288 384 302.3 384 320z';
const WATER_HEATER_PATH = 'M336 104C336 117.6 341.8 130.5 351.8 139.6L378.3 163.4C402.3 185 416 215.7 416 248C416 261.3 405.3 272 392 272C378.7 272 368 261.3 368 248C368 229.3 360.1 211.6 346.2 199.1L319.7 175.3C299.5 157.1 288 131.2 288 104C288 90.7 298.7 80 312 80C325.3 80 336 90.7 336 104zM96 400L96 320C96 284.7 124.7 256 160 256L179.7 256C187.8 256 195.9 257.6 203.5 260.6L340.6 315.4C348.2 318.4 356.2 320 364.4 320L480 320C515.3 320 544 348.7 544 384L544 512C544 547.3 515.3 576 480 576L160 576C124.7 576 96 547.3 96 512L96 400zM192 384C178.7 384 168 394.7 168 408L168 488C168 501.3 178.7 512 192 512C205.3 512 216 501.3 216 488L216 408C216 394.7 205.3 384 192 384zM344 408C344 394.7 333.3 384 320 384C306.7 384 296 394.7 296 408L296 488C296 501.3 306.7 512 320 512C333.3 512 344 501.3 344 488L344 408zM448 384C434.7 384 424 394.7 424 408L424 488C424 501.3 434.7 512 448 512C461.3 512 472 501.3 472 488L472 408C472 394.7 461.3 384 448 384zM424 80C437.3 80 448 90.7 448 104C448 117.6 453.8 130.5 463.8 139.6L490.3 163.4C514.3 185 528 215.7 528 248C528 261.3 517.3 272 504 272C490.7 272 480 261.3 480 248C480 229.3 472.1 211.6 458.2 199.1L431.7 175.3C411.5 157.1 400 131.2 400 104C400 90.7 410.7 80 424 80zM160 104C190.9 104 216 129.1 216 160C216 190.9 190.9 216 160 216C129.1 216 104 190.9 104 160C104 129.1 129.1 104 160 104z';
const CIRCLE_PATH = 'M528 320C528 205.1 434.9 112 320 112C205.1 112 112 205.1 112 320C112 434.9 205.1 528 320 528C434.9 528 528 434.9 528 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320z';
const CIRCLE_DOT_PATH = 'M320 576C178.6 576 64 461.4 64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576zM320 112C205.1 112 112 205.1 112 320C112 434.9 205.1 528 320 528C434.9 528 528 434.9 528 320C528 205.1 434.9 112 320 112zM320 416C267 416 224 373 224 320C224 267 267 224 320 224C373 224 416 267 416 320C416 373 373 416 320 416z';
const LIGHT_PATH = 'M420.9 448C428.2 425.7 442.8 405.5 459.3 388.1C492 353.7 512 307.2 512 256C512 150 426 64 320 64C214 64 128 150 128 256C128 307.2 148 353.7 180.7 388.1C197.2 405.5 211.9 425.7 219.1 448L420.8 448zM416 496L224 496L224 512C224 556.2 259.8 592 304 592L336 592C380.2 592 416 556.2 416 512L416 496zM312 176C272.2 176 240 208.2 240 248C240 261.3 229.3 272 216 272C202.7 272 192 261.3 192 248C192 181.7 245.7 128 312 128C325.3 128 336 138.7 336 152C336 165.3 325.3 176 312 176z';
const PLUG_PATH = 'M192 32C209.7 32 224 46.3 224 64L224 160L352 160L352 64C352 46.3 366.3 32 384 32C401.7 32 416 46.3 416 64L416 160L480 160C497.7 160 512 174.3 512 192C512 209.7 497.7 224 480 224L480 272.7C381.4 280.8 304 363.4 304 464C304 491.3 309.7 517.3 320 540.9L320 544C320 561.7 305.7 576 288 576C270.3 576 256 561.7 256 544L256 477.3C165.2 462.1 96 383.1 96 288L96 224C78.3 224 64 209.7 64 192C64 174.3 78.3 160 96 160L160 160L160 64C160 46.3 174.3 32 192 32zM352 464C352 384.5 416.5 320 496 320C575.5 320 640 384.5 640 464C640 543.5 575.5 608 496 608C416.5 608 352 543.5 352 464zM529.4 387C523.6 382.8 515.6 383 510 387.5L430 451.5C424.7 455.7 422.6 462.9 424.9 469.3C427.2 475.7 433.2 480 440 480L472.9 480L457 522.4C454.5 529.1 456.8 536.7 462.6 541C468.4 545.3 476.4 545 482 540.5L562 476.5C567.3 472.3 569.4 465.1 567.1 458.7C564.8 452.3 558.8 448 552 448L519.1 448L535 405.6C537.5 398.9 535.2 391.3 529.4 387z';
const POWER_SOURCE_PATH = 'M434.8 54.1C446.7 62.7 451.1 78.3 445.7 91.9L367.3 288L512 288C525.5 288 537.5 296.4 542.1 309.1C546.7 321.8 542.8 336 532.5 344.6L244.5 584.6C233.2 594 217.1 594.5 205.2 585.9C193.3 577.3 188.9 561.7 194.3 548.1L272.7 352L128 352C114.5 352 102.5 343.6 97.9 330.9C93.3 318.2 97.2 304 107.5 295.4L395.5 55.4C406.8 46 422.9 45.5 434.8 54.1z';
const BATTERY_PATH = 'M144 128C144 110.3 158.3 96 176 96L240 96C257.7 96 272 110.3 272 128L368 128C368 110.3 382.3 96 400 96L464 96C481.7 96 496 110.3 496 128L512 128C547.3 128 576 156.7 576 192L576 448C576 483.3 547.3 512 512 512L128 512C92.7 512 64 483.3 64 448L64 192C64 156.7 92.7 128 128 128L144 128zM456 248C456 234.7 445.3 224 432 224C418.7 224 408 234.7 408 248L408 280L376 280C362.7 280 352 290.7 352 304C352 317.3 362.7 328 376 328L408 328L408 360C408 373.3 418.7 384 432 384C445.3 384 456 373.3 456 360L456 328L488 328C501.3 328 512 317.3 512 304C512 290.7 501.3 280 488 280L456 280L456 248zM128 304C128 317.3 138.7 328 152 328L264 328C277.3 328 288 317.3 288 304C288 290.7 277.3 280 264 280L152 280C138.7 280 128 290.7 128 304z';
const CHARGING_STATION_PATH = 'M96 128C96 92.7 124.7 64 160 64L320 64C355.3 64 384 92.7 384 128L384 352C428.2 352 464 387.8 464 432L464 444C464 455 473 464 484 464C495 464 504 455 504 444L504 316.3C471.5 306.1 448 275.8 448 240L448 208C448 199.2 455.2 192 464 192L480 192L480 144C480 135.2 487.2 128 496 128C504.8 128 512 135.2 512 144L512 192L544 192L544 144C544 135.2 551.2 128 560 128C568.8 128 576 135.2 576 144L576 192L592 192C600.8 192 608 199.2 608 208L608 240C608 275.8 584.5 306.1 552 316.3L552 444C552 481.6 521.6 512 484 512C446.4 512 416 481.6 416 444L416 432C416 414.3 401.7 400 384 400L384 529.4C393.3 532.7 400 541.6 400 552C400 565.3 389.3 576 376 576L104 576C90.7 576 80 565.3 80 552C80 541.5 86.7 532.7 96 529.4L96 128zM178.7 253.7L217.7 253.7L196.8 320.6C194.4 328.2 200.1 336 208.1 336C211 336 213.7 335 215.9 333.1L310.5 251.1C313.6 248.4 315.4 244.5 315.4 240.4C315.4 232.6 309.1 226.3 301.3 226.3L262.3 226.3L283.2 159.4C285.6 151.8 279.9 144 271.9 144C269 144 266.3 145 264.1 146.9L169.5 228.9C166.4 231.6 164.6 235.5 164.6 239.6C164.6 247.4 170.9 253.7 178.7 253.7z';
const WALL_SCONCE_PATH = 'M512 320C512 214 426 128 320 128L320 512C426 512 512 426 512 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320z';
const ICONS = [
  { value: WC_PATH, terms: ['water','closet','wc','toilet','bathroom'] },
  { value: WF_PATH, terms: ['water','fountain'] },
  { value: SINK_PATH, terms: ['sink','faucet','basin'] },
  { value: HOSE_BIB_PATH, terms: ['hose','bib','spigot','faucet','outdoor'] },
  { value: SHOWER_PATH, terms: ['shower','showerhead'] },
  { value: BATH_PATH, terms: ['bath','bathtub'] },
  { value: LAUNDRY_PATH, terms: ['laundry','washer','washing machine'] },
  { value: WATER_HEATER_PATH, terms: ['water','heater','hot water'] },
  { value: CIRCLE_PATH, terms: ['circle','round','dot'] },
  { value: CIRCLE_DOT_PATH, terms: ['circle','dot','bullseye','target'] },
  { value: LIGHT_PATH, terms: ['light','bulb','lamp'] },
  { value: PLUG_PATH, terms: ['plug','outlet','electric','power'] },
  { value: POWER_SOURCE_PATH, terms: ['power','source','electric','bolt'] },
  { value: BATTERY_PATH, terms: ['battery','cell','power'] },
  { value: CHARGING_STATION_PATH, terms: ['charging','station','ev','electric','vehicle'] },
  { value: WALL_SCONCE_PATH, terms: ['wall','sconce','light','fixture'] }
];
const COLORS = ['#e85447','#4a9eff','#e8c547','#47c88e','#a47fff','#ff7a47','#47d4d4','#ff47b0','#bfff47','#ffffff'];
const SCALE_MODES = { NONE: 0, POINT_A: 1, POINT_B: 2 };
const TOOL = { NONE: '', SCALE: 'scale', LINE: 'line', POLYLINE: 'polyline', COUNTER: 'counter', EDIT_POLY: 'edit_poly' };

// ─── STATE ───────────────────────────────────────────────────────────────────
const state = {
  pages: [],          // [{ pdfData, annotations: { counters, polylines, quickLines, markers } }]
  currentPage: 0,
  scale: null,        // { pixelsPerUnit, unit, zoom } — stored at display zoom=1
  zoom: 1.0,
  tool: TOOL.NONE,
  scaleMode: SCALE_MODES.NONE,
  scalePointA: null,
  scalePointB: null,
  activeCounterType: null,   // counter definition id
  activePolylineId: null,
  drawingPolyline: null,     // { points: [], color, name, closed }
  quickLineStart: null,
  mousePos: { x: 0, y: 0 },
  pan: { x: 0, y: 0 },
  isPanning: false,
  panStart: null,
  counters: [],       // [{ id, name, icon, color }]
  lineTypes: [],     // [{ id, name, color }]
  activeLineTypeId: null,
  ctxTarget: null,    // for right-click context
  selectedLineId: null,   // id of line run selected in sidebar (for highlight)
  selectedLineIsPoly: false,
  editingPolyline: null,     // polyline object removed from ann.polylines while being edited
  editingPolyIndex: null,    // original index in ann.polylines for reinsertion
  draggingVertexIdx: null,   // index of vertex currently being dragged
};

// Page annotations structure factory
function makeAnnotations() {
  return { counterMarkers: {}, polylines: [], quickLines: [] };
}

// ─── PDF RENDERING ─────────────────────────────────────────────────────────
const pdfCanvas = document.getElementById('pdf-canvas');
const pdfCanvasBuffer = document.getElementById('pdf-canvas-buffer');
const annCanvas = document.getElementById('annotation-canvas');
const pdfCtx = pdfCanvas.getContext('2d');
const annCtx = annCanvas.getContext('2d');
let currentPdfPage = null;
let renderPromise = Promise.resolve();

async function loadPDFFile(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const label = file.name.replace('.pdf','') + (pdf.numPages > 1 ? ` — p${i}` : '');
    state.pages.push({ pdfPage: page, label, annotations: makeAnnotations() });
  }
}

async function renderCurrentPage() {
  if (state.pages.length === 0) return;
  const prev = renderPromise;
  renderPromise = (async () => {
    await prev;
    const page = state.pages[state.currentPage];
    const viewport = page.pdfPage.getViewport({ scale: state.zoom });

    // Render to the hidden canvas (keeps visible canvas showing previous frame, no white flash)
    const targetPdf = pdfCanvasBuffer.classList.contains('pdf-hidden') ? pdfCanvasBuffer : pdfCanvas;
    const otherPdf = targetPdf === pdfCanvas ? pdfCanvasBuffer : pdfCanvas;
    targetPdf.width = viewport.width;
    targetPdf.height = viewport.height;
    const targetCtx = targetPdf.getContext('2d');
    await page.pdfPage.render({ canvasContext: targetCtx, viewport }).promise;

    // Swap visibility: show newly rendered canvas, hide the other
    targetPdf.classList.remove('pdf-hidden');
    otherPdf.classList.add('pdf-hidden');
    annCanvas.width = viewport.width;
    annCanvas.height = viewport.height;
    redraw();
    updateNav();
    updatePageList();
    updatePanTransform();
  })();
  return renderPromise;
}

function fitToView() {
  if (state.pages.length === 0) return;
  state.pan = { x: 0, y: 0 };
  const area = document.getElementById('canvas-area');
  const page = state.pages[state.currentPage];
  const vp = page.pdfPage.getViewport({ scale: 1 });
  const scaleX = (area.clientWidth - 80) / vp.width;
  const scaleY = (area.clientHeight - 80) / vp.height;
  state.zoom = Math.min(scaleX, scaleY, 2);
  renderCurrentPage();
  updateZoomLabel();
  updatePanTransform();
}

function adjustZoom(delta) {
  const oldZoom = state.zoom;
  const newZoom = Math.max(0.2, Math.min(4, state.zoom + delta));
  // Scale pan with zoom so view feels consistent: zoom out drifts toward center, zoom in scales pan up
  if (oldZoom !== 0) {
    state.pan.x *= newZoom / oldZoom;
    state.pan.y *= newZoom / oldZoom;
  }
  state.zoom = newZoom;
  renderCurrentPage();
  updateZoomLabel();
}

function updateZoomLabel() {
  document.getElementById('zoom-label').textContent = Math.round(state.zoom * 100) + '%';
}

function updatePanTransform() {
  const wrapper = document.getElementById('canvas-wrapper');
  if (!wrapper) return;
  wrapper.style.transform = `translate(-50%, -50%) translate(${state.pan.x}px, ${state.pan.y}px)`;
}

// ─── CANVAS COORDINATE HELPERS ───────────────────────────────────────────────
function canvasPos(e) {
  const rect = annCanvas.getBoundingClientRect();
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

// Returns coordinates normalized to PDF-space (zoom-independent).
// All stored annotation coordinates use this space so they stay
// pinned to the correct location regardless of zoom level.
function pdfPos(e) {
  const rect = annCanvas.getBoundingClientRect();
  return {
    x: (e.clientX - rect.left) / state.zoom,
    y: (e.clientY - rect.top) / state.zoom,
  };
}

// Scale a PDF-space point to current canvas-space for drawing.
function toCanvas(p) {
  return { x: p.x * state.zoom, y: p.y * state.zoom };
}

// ─── REDRAW ───────────────────────────────────────────────────────────────────
function redraw() {
  const w = annCanvas.width, h = annCanvas.height;
  annCtx.clearRect(0, 0, w, h);
  if (state.pages.length === 0) return;
  const ann = state.pages[state.currentPage].annotations;

  // Draw quick lines (skip selected so we draw it last with highlight)
  for (const line of ann.quickLines) {
    if (state.selectedLineId === line.id && !state.selectedLineIsPoly) continue;
    drawLineAnnotation(line);
  }

  // Draw polylines (skip selected so we draw it last with highlight)
  for (const poly of ann.polylines) {
    if (state.selectedLineId === poly.id && state.selectedLineIsPoly) continue;
    drawPolylineAnnotation(poly);
  }

  // Draw selected line on top with prominence (skip if it's the editing polyline — drawn below)
  if (state.selectedLineId && !(state.editingPolyline?.id === state.selectedLineId && state.selectedLineIsPoly)) {
    if (state.selectedLineIsPoly) {
      const poly = ann.polylines.find(p => p.id === state.selectedLineId);
      if (poly) drawPolylineAnnotation(poly, true);
    } else {
      const line = ann.quickLines.find(l => l.id === state.selectedLineId);
      if (line) drawLineAnnotation(line, true);
    }
  }

  // Draw the polyline currently being edited with highlighted vertices
  if (state.editingPolyline && state.editingPolyline.points.length > 0) {
    const isSelected = state.selectedLineId === state.editingPolyline.id && state.selectedLineIsPoly;
    drawPolylineAnnotation(state.editingPolyline, isSelected);
    const z = state.zoom;
    const poly = state.editingPolyline;
    const mousePdf = { x: state.mousePos.x / z, y: state.mousePos.y / z };
    poly.points.forEach((p, i) => {
      const cx = p.x * z, cy = p.y * z;
      const isHovered = ptDist(p, mousePdf) < 12 / z;
      const isDragging = state.draggingVertexIdx === i;
      // Outer glow ring
      annCtx.beginPath();
      annCtx.arc(cx, cy, 10, 0, Math.PI * 2);
      annCtx.strokeStyle = isDragging ? '#fff' : (isHovered ? poly.color : poly.color + '88');
      annCtx.lineWidth = isDragging ? 2 : 1.5;
      annCtx.stroke();
      // Inner filled dot
      annCtx.beginPath();
      annCtx.arc(cx, cy, 6, 0, Math.PI * 2);
      annCtx.fillStyle = isDragging ? '#fff' : poly.color;
      annCtx.fill();
    });
  }

  // Draw counter markers
  for (const [typeId, markers] of Object.entries(ann.counterMarkers)) {
    const def = state.counters.find(c => c.id === typeId);
    if (!def) continue;
    markers.forEach((m, idx) => {
      drawMarker(m.x * state.zoom, m.y * state.zoom, def.icon, def.color, idx + 1);
    });
  }

  // Draw in-progress polyline
  // pts are PDF-space; mousePos is canvas-space. Scale pts up for drawing.
  if (state.drawingPolyline && state.drawingPolyline.points.length > 0) {
    const pts = state.drawingPolyline.points;
    const color = state.drawingPolyline.color;
    const z = state.zoom;
    annCtx.strokeStyle = color;
    annCtx.lineWidth = 2;
    annCtx.setLineDash([6, 3]);
    annCtx.beginPath();
    annCtx.moveTo(pts[0].x * z, pts[0].y * z);
    for (let i = 1; i < pts.length; i++) annCtx.lineTo(pts[i].x * z, pts[i].y * z);
    annCtx.lineTo(state.mousePos.x, state.mousePos.y);
    annCtx.stroke();
    annCtx.setLineDash([]);
    // Draw vertices
    pts.forEach(p => {
      annCtx.beginPath();
      annCtx.arc(p.x * z, p.y * z, 4, 0, Math.PI * 2);
      annCtx.fillStyle = color;
      annCtx.fill();
    });
    // Running total HUD — convert mousePos to PDF-space for distance calc
    const mousePdf = { x: state.mousePos.x / z, y: state.mousePos.y / z };
    const dist = polylineDistance(pts) + ptDist(pts[pts.length - 1], mousePdf);
    updateHUD(`${formatDist(dist)} (running)`, state.mousePos.x + 16, state.mousePos.y);
  }

  // Draw scale in-progress
  // scalePointA is PDF-space; draw scaled up. mousePos is canvas-space.
  if (state.scaleMode === SCALE_MODES.POINT_A || state.scaleMode === SCALE_MODES.POINT_B) {
    if (state.scalePointA) {
      const spA = toCanvas(state.scalePointA);
      annCtx.beginPath();
      annCtx.arc(spA.x, spA.y, 5, 0, Math.PI * 2);
      annCtx.fillStyle = '#fff';
      annCtx.fill();
      if (state.scaleMode === SCALE_MODES.POINT_B) {
        annCtx.strokeStyle = '#fff';
        annCtx.lineWidth = 1.5;
        annCtx.setLineDash([5, 3]);
        annCtx.beginPath();
        annCtx.moveTo(spA.x, spA.y);
        annCtx.lineTo(state.mousePos.x, state.mousePos.y);
        annCtx.stroke();
        annCtx.setLineDash([]);
        // Show PDF-point distance so the modal value matches
        const mousePdf = { x: state.mousePos.x / state.zoom, y: state.mousePos.y / state.zoom };
        const d = ptDist(state.scalePointA, mousePdf);
        updateHUD(`${Math.round(d)} pdf-pts`, state.mousePos.x + 16, state.mousePos.y);
      }
    }
  }

  // Quick line in progress
  // quickLineStart is PDF-space; mousePos is canvas-space.
  if (state.tool === TOOL.LINE && state.quickLineStart) {
    const qs = toCanvas(state.quickLineStart);
    const lt = state.lineTypes.find(l => l.id === state.activeLineTypeId);
    annCtx.strokeStyle = lt ? lt.color : '#e8c547';
    annCtx.lineWidth = 2;
    annCtx.setLineDash([5, 3]);
    annCtx.beginPath();
    annCtx.moveTo(qs.x, qs.y);
    annCtx.lineTo(state.mousePos.x, state.mousePos.y);
    annCtx.stroke();
    annCtx.setLineDash([]);
    const mousePdf = { x: state.mousePos.x / state.zoom, y: state.mousePos.y / state.zoom };
    const d = ptDist(state.quickLineStart, mousePdf);
    updateHUD(formatDist(d), state.mousePos.x + 16, state.mousePos.y);
  }
}

function drawLineAnnotation(line, highlight = false) {
  const z = state.zoom;
  const x1 = line.x1 * z, y1 = line.y1 * z, x2 = line.x2 * z, y2 = line.y2 * z;
  const color = line.color || '#fff';
  if (highlight) {
    annCtx.strokeStyle = '#fff';
    annCtx.lineWidth = 5;
    annCtx.beginPath();
    annCtx.moveTo(x1, y1);
    annCtx.lineTo(x2, y2);
    annCtx.stroke();
  }
  annCtx.strokeStyle = color;
  annCtx.lineWidth = highlight ? 3.5 : 1.5;
  annCtx.beginPath();
  annCtx.moveTo(x1, y1);
  annCtx.lineTo(x2, y2);
  annCtx.stroke();
  // endpoints
  const r = highlight ? 5 : 3.5;
  [[x1, y1], [x2, y2]].forEach(([x, y]) => {
    if (highlight) {
      annCtx.beginPath();
      annCtx.arc(x, y, r + 2, 0, Math.PI * 2);
      annCtx.fillStyle = '#fff';
      annCtx.fill();
    }
    annCtx.beginPath();
    annCtx.arc(x, y, r, 0, Math.PI * 2);
    annCtx.fillStyle = color;
    annCtx.fill();
  });
  // label — distance in PDF-space, label position in canvas-space
  const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
  const d = ptDist({x:line.x1,y:line.y1}, {x:line.x2,y:line.y2});
  drawLabel(formatDist(d), mx, my - 8, color);
}

function drawPolylineAnnotation(poly, highlight = false) {
  if (!poly.points || poly.points.length < 2) return;
  const color = poly.color;
  const z = state.zoom;
  annCtx.lineJoin = 'round';
  if (highlight) {
    annCtx.strokeStyle = '#fff';
    annCtx.lineWidth = 5;
    annCtx.beginPath();
    annCtx.moveTo(poly.points[0].x * z, poly.points[0].y * z);
    for (let i = 1; i < poly.points.length; i++) annCtx.lineTo(poly.points[i].x * z, poly.points[i].y * z);
    if (poly.closed) annCtx.closePath();
    annCtx.stroke();
  }
  annCtx.strokeStyle = color;
  annCtx.lineWidth = highlight ? 4 : 2;
  annCtx.beginPath();
  annCtx.moveTo(poly.points[0].x * z, poly.points[0].y * z);
  for (let i = 1; i < poly.points.length; i++) annCtx.lineTo(poly.points[i].x * z, poly.points[i].y * z);
  if (poly.closed) annCtx.closePath();
  annCtx.stroke();
  // vertices
  const r = highlight ? 6 : 4;
  poly.points.forEach(p => {
    if (highlight) {
      annCtx.beginPath();
      annCtx.arc(p.x * z, p.y * z, r + 2, 0, Math.PI * 2);
      annCtx.fillStyle = '#fff';
      annCtx.fill();
    }
    annCtx.beginPath();
    annCtx.arc(p.x * z, p.y * z, r, 0, Math.PI * 2);
    annCtx.fillStyle = color;
    annCtx.fill();
  });
  // total label — distances in PDF-space, label position in canvas-space
  const total = polylineDistance(poly.points, poly.closed);
  const midPt = poly.points[Math.floor(poly.points.length / 2)];
  drawLabel(`${poly.name}: ${formatDist(total)}`, midPt.x * z, midPt.y * z - 14, color);
  if (poly.closed && state.scale) {
    const area = polygonArea(poly.points);
    drawLabel(`Area: ${formatArea(area)}`, midPt.x * z, midPt.y * z + 4, color + 'cc');
  }
}

function drawMarker(x, y, icon, color, num) {
  // Colored circle fill
  annCtx.beginPath();
  annCtx.arc(x, y, 14, 0, Math.PI * 2);
  annCtx.fillStyle = color + '66';
  annCtx.fill();
  // Cut out SVG shape from circle (SVG icons only)
  if (isSvgIcon(icon)) {
    annCtx.save();
    annCtx.globalCompositeOperation = 'destination-out';
    const path = new Path2D(icon);
    const s = (28 / 640) * 0.75;
    annCtx.translate(x, y);
    annCtx.scale(s, s);
    annCtx.translate(-320, -320);
    annCtx.fillStyle = '#fff';
    annCtx.fill(path);
    annCtx.restore();
  }
  // Circle stroke
  annCtx.beginPath();
  annCtx.arc(x, y, 14, 0, Math.PI * 2);
  annCtx.strokeStyle = color;
  annCtx.lineWidth = 1.5;
  annCtx.stroke();
  // Icon for emoji only (SVG already handled by cutout)
  if (!isSvgIcon(icon)) {
    annCtx.save();
    annCtx.globalAlpha = 0.5;
    annCtx.font = '13px serif';
    annCtx.textAlign = 'center';
    annCtx.textBaseline = 'middle';
    annCtx.fillText(icon, x, y - 1);
    annCtx.restore();
  }
  // Badge
  annCtx.beginPath();
  annCtx.arc(x + 10, y - 10, 7, 0, Math.PI * 2);
  annCtx.fillStyle = color;
  annCtx.fill();
  annCtx.font = 'bold 8px DM Sans, sans-serif';
  annCtx.fillStyle = '#000';
  annCtx.textAlign = 'center';
  annCtx.textBaseline = 'middle';
  annCtx.fillText(String(num), x + 10, y - 10);
  annCtx.textAlign = 'left';
  annCtx.textBaseline = 'alphabetic';
}

function drawLabel(text, x, y, color) {
  annCtx.font = '11px DM Mono, monospace';
  const w = annCtx.measureText(text).width;
  annCtx.fillStyle = 'rgba(15,15,17,0.75)';
  annCtx.fillRect(x - w/2 - 4, y - 9, w + 8, 16);
  annCtx.fillStyle = color;
  annCtx.textAlign = 'center';
  annCtx.fillText(text, x, y + 2);
  annCtx.textAlign = 'left';
}

// ─── DISTANCE HELPERS ─────────────────────────────────────────────────────────
function ptDist(a, b) {
  return Math.sqrt((b.x - a.x) ** 2 + (b.y - a.y) ** 2);
}

function polylineDistance(pts, closed = false) {
  let d = 0;
  for (let i = 1; i < pts.length; i++) d += ptDist(pts[i-1], pts[i]);
  if (closed && pts.length > 2) d += ptDist(pts[pts.length-1], pts[0]);
  return d;
}

function polygonArea(pts) {
  let area = 0;
  for (let i = 0; i < pts.length; i++) {
    const j = (i + 1) % pts.length;
    area += pts[i].x * pts[j].y;
    area -= pts[j].x * pts[i].y;
  }
  return Math.abs(area) / 2;
}

function formatDist(pdfPts) {
  if (!state.scale) return `${Math.round(pdfPts)} px`;
  const real = pdfPts / state.scale.pixelsPerUnit;
  return `${real.toFixed(2)} ${state.scale.unit}`;
}

function formatArea(sqPdfPts) {
  if (!state.scale) return `${Math.round(sqPdfPts)} px²`;
  const ppu = state.scale.pixelsPerUnit;
  const real = sqPdfPts / (ppu * ppu);
  return `${real.toFixed(1)} ${state.scale.unit}²`;
}

// ─── HUD ─────────────────────────────────────────────────────────────────────
function updateHUD(text, x, y) {
  const hud = document.getElementById('hud');
  const rect = annCanvas.getBoundingClientRect();
  const container = document.getElementById('canvas-area').getBoundingClientRect();
  hud.style.display = 'block';
  hud.style.left = (rect.left - container.left + x) + 'px';
  hud.style.top = (rect.top - container.top + y) + 'px';
  hud.textContent = text;
}

function hideHUD() { document.getElementById('hud').style.display = 'none'; }

// ─── SCALE TOOL ───────────────────────────────────────────────────────────────
function startScaleMode() {
  setTool(TOOL.SCALE);
  state.scaleMode = SCALE_MODES.POINT_A;
  state.scalePointA = null;
  state.scalePointB = null;
  setStatus('Click the first reference point on the drawing');
}

function confirmScale() {
  const val = parseFloat(document.getElementById('scale-value').value);
  const unit = document.getElementById('scale-unit').value;
  if (!val || val <= 0) return;
  // Scale points are stored in PDF-space, so ptDist gives PDF points.
  // pixelsPerUnit = PDF points per real-world unit (zoom-independent).
  const pdfPts = ptDist(state.scalePointA, state.scalePointB);
  state.scale = { pixelsPerUnit: pdfPts / val, unit };
  closeModal('modal-scale');
  document.getElementById('scale-display').textContent = `Scale: 1 ${unit} = ${state.scale.pixelsPerUnit.toFixed(1)} pdf-pts`;
  document.getElementById('scale-display').style.display = '';
  setTool(TOOL.NONE);
  redraw();
  saveToStorage();
}

// ─── LINE TOOL ────────────────────────────────────────────────────────────────
function startLineMode() {
  if (!state.scale) {
    alert('Set a scale first using the "Set Scale" button.');
    return;
  }
  if (state.lineTypes.length === 0) {
    alert('Create a line type first.');
    openLineTypeModal();
    return;
  }
  if (!state.activeLineTypeId) {
    alert('Select a line type from the sidebar first.');
    renderLineTypeList();
    return;
  }
  setTool(TOOL.LINE);
  state.quickLineStart = null;
  setStatus('Click to start a quick measurement line');
}

// ─── POLYLINE MODAL ──────────────────────────────────────────────────────────
let pendingPolyColor = COLORS[0];
let pendingLineTypeId = null;

function openPolylineModal() {
  if (!state.scale) { alert('Set a scale first.'); return; }
  if (state.lineTypes.length === 0) {
    alert('Create a line type first.');
    openLineTypeModal();
    return;
  }
  document.getElementById('poly-name').value = '';
  const sel = document.getElementById('poly-line-type');
  sel.innerHTML = '<option value="">— Select —</option>';
  state.lineTypes.forEach(lt => {
    const opt = document.createElement('option');
    opt.value = lt.id;
    opt.textContent = lt.name;
    sel.appendChild(opt);
  });
  const defId = state.activeLineTypeId || state.lineTypes[0].id;
  sel.value = defId;
  pendingLineTypeId = defId;
  const def = state.lineTypes.find(l => l.id === defId);
  if (def) { pendingPolyColor = def.color; }
  sel.onchange = () => {
    const id = sel.value;
    const d = id ? state.lineTypes.find(l => l.id === id) : null;
    if (d) { pendingPolyColor = d.color; renderColorRow('poly-color-row', 'pendingPolyColor'); }
  };
  renderColorRow('poly-color-row', 'pendingPolyColor');
  openModal('modal-polyline');
}

function confirmPolyline() {
  const name = document.getElementById('poly-name').value.trim() || 'Line';
  const lineTypeId = document.getElementById('poly-line-type').value || null;
  const def = lineTypeId ? state.lineTypes.find(l => l.id === lineTypeId) : null;
  const color = def ? def.color : pendingPolyColor;
  closeModal('modal-polyline');
  state.drawingPolyline = { id: uid(), name, color, points: [], closed: false, lineTypeId: lineTypeId || undefined };
  setTool(TOOL.POLYLINE);
  setStatus('Click to add vertices. Double-click to finish. Right-click to close polygon.');
}

// ─── COUNTER MODAL ─────────────────────────────────────────────────────────
let pendingCounterIcon = ICONS[0].value;
let pendingCounterColor = COLORS[0];

function openCounterModal() {
  document.getElementById('counter-name').value = '';
  document.getElementById('icon-search').value = '';
  pendingCounterIcon = ICONS[0].value;
  pendingCounterColor = COLORS[0];
  window.pendingCounterColor = pendingCounterColor;
  renderIconGrid();
  renderColorRow('counter-color-row', 'pendingCounterColor');
  openModal('modal-counter');
}

function isSvgIcon(val) { return typeof val === 'string' && val.startsWith('M'); }

function renderIconHtml(icon) {
  if (isSvgIcon(icon)) {
    return `<svg viewBox="0 0 640 640" width="14" height="14" style="vertical-align:middle"><path d="${icon}" fill="currentColor"/></svg>`;
  }
  return icon;
}

function iconToStatusText(icon) {
  if (!isSvgIcon(icon)) return icon;
  if (icon === WC_PATH) return 'WC';
  if (icon === WF_PATH) return 'WF';
  if (icon === SINK_PATH) return 'Sink';
  if (icon === HOSE_BIB_PATH) return 'Hose Bib';
  if (icon === SHOWER_PATH) return 'Shower';
  if (icon === BATH_PATH) return 'Bath';
  if (icon === LAUNDRY_PATH) return 'Laundry';
  if (icon === WATER_HEATER_PATH) return 'Water Heater';
  if (icon === CIRCLE_PATH) return 'Circle';
  if (icon === CIRCLE_DOT_PATH) return 'Circle Dot';
  if (icon === LIGHT_PATH) return 'Light';
  if (icon === PLUG_PATH) return 'Plug';
  if (icon === POWER_SOURCE_PATH) return 'Power Source';
  if (icon === BATTERY_PATH) return 'Battery';
  if (icon === CHARGING_STATION_PATH) return 'Charging Station';
  if (icon === WALL_SCONCE_PATH) return 'Wall Sconce';
  return '';
}

function renderIconGrid() {
  const grid = document.getElementById('icon-grid');
  const searchEl = document.getElementById('icon-search');
  const q = (searchEl && searchEl.value || '').trim().toLowerCase();
  grid.innerHTML = '';
  const filtered = q ? ICONS.filter(i => i.terms.some(t => t.includes(q))) : ICONS;
  filtered.forEach(icon => {
    const val = icon.value;
    const el = document.createElement('div');
    el.className = 'icon-opt' + (val === pendingCounterIcon ? ' selected' : '');
    if (isSvgIcon(val)) {
      el.innerHTML = `<svg viewBox="0 0 640 640" width="24" height="24"><path d="${val}" fill="currentColor"/></svg>`;
    } else {
      el.textContent = val;
    }
    el.onclick = () => {
      pendingCounterIcon = val;
      renderIconGrid();
    };
    grid.appendChild(el);
  });
}

function renderColorRow(id, varName) {
  const row = document.getElementById(id);
  row.innerHTML = '';
  COLORS.forEach(c => {
    const el = document.createElement('div');
    el.className = 'color-swatch' + (c === window[varName] ? ' selected' : '');
    el.style.background = c;
    el.onclick = () => { window[varName] = c; renderColorRow(id, varName); };
    row.appendChild(el);
  });
}

function confirmCounter() {
  const name = document.getElementById('counter-name').value.trim() || 'Counter';
  const def = { id: uid(), name, icon: pendingCounterIcon, color: window.pendingCounterColor ?? pendingCounterColor };
  state.counters.push(def);
  // Init empty markers on all pages
  state.pages.forEach(p => { p.annotations.counterMarkers[def.id] = []; });
  closeModal('modal-counter');
  activateCounter(def.id);
  renderCounterList();
  saveToStorage();
}

function activateCounter(id) {
  state.activeCounterType = id;
  setTool(TOOL.COUNTER);
  const def = state.counters.find(c => c.id === id);
  setStatus(`Placing: ${iconToStatusText(def.icon)} ${def.name} — click to count`);
  renderCounterList();
}

// ─── LINE TYPE MODAL ─────────────────────────────────────────────────────────
let pendingLineTypeColor = COLORS[0];

function openLineTypeModal() {
  document.getElementById('line-type-name').value = '';
  pendingLineTypeColor = COLORS[0];
  renderColorRow('line-type-color-row', 'pendingLineTypeColor');
  openModal('modal-line-type');
}

let reopenPolylineAfterLineType = false;

function confirmLineType() {
  const name = document.getElementById('line-type-name').value.trim() || 'Line Type';
  const def = { id: uid(), name, color: pendingLineTypeColor };
  state.lineTypes.push(def);
  closeModal('modal-line-type');
  state.activeLineTypeId = def.id;
  renderLineTypeList();
  renderPolyList();
  updateSummary();
  saveToStorage();
  if (reopenPolylineAfterLineType) {
    reopenPolylineAfterLineType = false;
    openPolylineModal();
  }
}

function getLineStatsForType(lineTypeId) {
  return getLineStatsForTypeOnPage(lineTypeId, state.currentPage);
}

function getLineStatsForTypeOnPage(lineTypeId, pageIndex) {
  const ann = state.pages[pageIndex]?.annotations;
  if (!ann) return { runs: 0, length: 0 };
  const polylines = (ann.polylines || []).filter(p => (p.lineTypeId || null) === (lineTypeId || null));
  const quickLines = (ann.quickLines || []).filter(q => (q.lineTypeId || null) === (lineTypeId || null));
  let length = 0;
  polylines.forEach(p => {
    for (let i = 1; i < p.points.length; i++) length += ptDist(p.points[i - 1], p.points[i]);
    if (p.closed && p.points.length > 2) length += ptDist(p.points[p.points.length - 1], p.points[0]);
  });
  quickLines.forEach(q => length += ptDist({ x: q.x1, y: q.y1 }, { x: q.x2, y: q.y2 }));
  return { runs: polylines.length + quickLines.length, length };
}

function renderLineTypeList() {
  const list = document.getElementById('line-type-list');
  list.innerHTML = '';
  state.lineTypes.forEach(lt => {
    const stats = getLineStatsForType(lt.id);
    const el = document.createElement('div');
    el.className = 'line-type-item' + (state.activeLineTypeId === lt.id ? ' active' : '');
    const swatch = document.createElement('div');
    swatch.className = 'line-type-swatch';
    swatch.style.background = lt.color;
    const nameSpan = document.createElement('span');
    nameSpan.className = 'line-type-name';
    nameSpan.textContent = lt.name;
    nameSpan.ondblclick = (e) => {
      e.stopPropagation();
      startInlineRename(nameSpan, lt.name, (val) => {
        lt.name = val;
        renderLineTypeList();
        renderPolyList();
        updateSummary();
        saveToStorage();
      });
    };
    const statsSpan = document.createElement('span');
    statsSpan.className = 'line-type-stats';
    statsSpan.textContent = `${stats.runs} runs · ${formatDist(stats.length)}`;
    el.appendChild(swatch);
    el.appendChild(nameSpan);
    el.appendChild(statsSpan);
    el.onclick = (e) => {
      if (e.target.closest('.line-type-name') || e.target.closest('.inline-rename-input')) return;
      state.activeLineTypeId = lt.id;
      renderLineTypeList();
    };
    list.appendChild(el);
  });
}

// ─── CANVAS EVENTS ────────────────────────────────────────────────────────────
annCanvas.addEventListener('mousemove', e => {
  const pos = canvasPos(e);
  state.mousePos = pos;
  document.getElementById('status-coords').textContent = `x:${Math.round(pos.x)} y:${Math.round(pos.y)}`;

  if (state.tool === TOOL.EDIT_POLY && state.editingPolyline) {
    if (state.draggingVertexIdx !== null) {
      // Move the dragged vertex
      state.editingPolyline.points[state.draggingVertexIdx] = pdfPos(e);
      renderPolyList();
    }
    // Update cursor: grab when over a vertex
    const p = pdfPos(e);
    const r = 12 / state.zoom;
    const overVertex = state.editingPolyline.points.some(pt => ptDist(pt, p) < r);
    const canvasArea = document.getElementById('canvas-area');
    if (state.draggingVertexIdx !== null) {
      canvasArea.classList.add('dragging');
    } else {
      canvasArea.classList.remove('dragging');
      annCanvas.style.cursor = overVertex ? 'grab' : 'default';
    }
    redraw();
    return;
  }

  if (state.tool !== TOOL.NONE) redraw();
});

annCanvas.addEventListener('mousedown', e => {
  if (e.button !== 0) return;
  if (state.tool === TOOL.EDIT_POLY && state.editingPolyline) {
    const p = pdfPos(e);
    const r = 12 / state.zoom;
    const idx = state.editingPolyline.points.findIndex(pt => ptDist(pt, p) < r);
    if (idx !== -1) {
      state.draggingVertexIdx = idx;
      annCanvas.style.cursor = 'grabbing';
      document.getElementById('canvas-area').classList.add('dragging');
      e.preventDefault();
    }
  }
});

annCanvas.addEventListener('mouseup', e => {
  if (state.tool === TOOL.EDIT_POLY && state.draggingVertexIdx !== null) {
    state.draggingVertexIdx = null;
    annCanvas.style.cursor = 'default';
    document.getElementById('canvas-area').classList.remove('dragging');
    saveToStorage();
    redraw();
  }
});

annCanvas.addEventListener('mouseleave', () => { hideHUD(); });

annCanvas.addEventListener('click', e => {
  if (e.button !== 0) return;
  if (state.tool === TOOL.EDIT_POLY) return; // handled by mousedown/mouseup
  const pos = canvasPos(e);

  if (state.tool === TOOL.SCALE) {
    if (state.scaleMode === SCALE_MODES.POINT_A) {
      state.scalePointA = pdfPos(e);
      state.scaleMode = SCALE_MODES.POINT_B;
      setStatus('Now click the second reference point');
      redraw();
    } else if (state.scaleMode === SCALE_MODES.POINT_B) {
      state.scalePointB = pdfPos(e);
      state.scaleMode = SCALE_MODES.NONE;
      const pixels = ptDist(state.scalePointA, state.scalePointB);
      document.getElementById('scale-px-info').textContent = `You selected a line spanning ${Math.round(pixels)} pdf-pts.`;
      document.getElementById('scale-value').value = '';
      document.getElementById('scale-preview').textContent = 'Enter a value above to preview scale';
      openModal('modal-scale');
      redraw();
    }
    return;
  }

  if (state.tool === TOOL.LINE) {
    if (!state.quickLineStart) {
      state.quickLineStart = pdfPos(e);
    } else {
      const pp = pdfPos(e);
      const ann = state.pages[state.currentPage].annotations;
      const lt = state.lineTypes.find(l => l.id === state.activeLineTypeId);
      ann.quickLines.push({ x1: state.quickLineStart.x, y1: state.quickLineStart.y, x2: pp.x, y2: pp.y, color: lt ? lt.color : '#e8c547', id: uid(), lineTypeId: state.activeLineTypeId });
      state.quickLineStart = null;
      setTool(TOOL.NONE);
      redraw();
      renderLineTypeList();
      renderPolyList();
      updateSummary();
      saveToStorage();
    }
    return;
  }

  if (state.tool === TOOL.POLYLINE && state.drawingPolyline) {
    state.drawingPolyline.points.push(pdfPos(e));
    redraw();
    return;
  }

  if (state.tool === TOOL.COUNTER && state.activeCounterType) {
    const ann = state.pages[state.currentPage].annotations;
    if (!ann.counterMarkers[state.activeCounterType]) ann.counterMarkers[state.activeCounterType] = [];
    const pp = pdfPos(e);
    ann.counterMarkers[state.activeCounterType].push({ x: pp.x, y: pp.y, id: uid() });
    redraw();
    renderCounterList();
    updateSummary();
    saveToStorage();
    return;
  }
});

annCanvas.addEventListener('dblclick', e => {
  if (state.tool === TOOL.POLYLINE && state.drawingPolyline && state.drawingPolyline.points.length >= 2) {
    finishPolyline(false);
  }
});

annCanvas.addEventListener('contextmenu', e => {
  e.preventDefault();
  const pos = canvasPos(e);

  if (state.tool === TOOL.POLYLINE && state.drawingPolyline && state.drawingPolyline.points.length >= 3) {
    finishPolyline(true);
    return;
  }

  // In edit mode: right-click on a vertex deletes it
  if (state.tool === TOOL.EDIT_POLY && state.editingPolyline) {
    const p = pdfPos(e);
    const r = 12 / state.zoom;
    const idx = state.editingPolyline.points.findIndex(pt => ptDist(pt, p) < r);
    if (idx !== -1) {
      state.editingPolyline.points.splice(idx, 1);
      if (state.editingPolyline.points.length < 2) {
        // Line has fewer than 2 points — discard it
        exitEditMode(false);
      } else {
        redraw();
        renderLineTypeList();
        renderPolyList();
        saveToStorage();
      }
    }
    return;
  }

  // Check if clicking near an annotation
  const target = hitTest(pos);
  if (target) {
    state.ctxTarget = target;
    const menu = document.getElementById('ctx-menu');
    menu.style.display = 'block';
    menu.style.left = e.clientX + 'px';
    menu.style.top = e.clientY + 'px';
  }
});

document.addEventListener('click', () => {
  document.getElementById('ctx-menu').style.display = 'none';
});

// ─── PAN (drag to pan when no tool active) ────────────────────────────────────
const canvasArea = document.getElementById('canvas-area');

canvasArea.addEventListener('mousedown', e => {
  if (e.button !== 0) return;
  if (state.tool !== TOOL.NONE) return;
  if (e.target.closest('button')) return;
  if (state.pages.length === 0) return;
  if (document.getElementById('canvas-wrapper').style.display === 'none') return;
  state.isPanning = true;
  state.panStart = { x: e.clientX, y: e.clientY };
  canvasArea.classList.add('panning');
  e.preventDefault();
});

document.addEventListener('mousemove', e => {
  if (!state.isPanning || !state.panStart) return;
  const dx = e.clientX - state.panStart.x;
  const dy = e.clientY - state.panStart.y;
  state.pan.x += dx;
  state.pan.y += dy;
  state.panStart = { x: e.clientX, y: e.clientY };
  updatePanTransform();
});

document.addEventListener('mouseup', e => {
  if (e.button !== 0) return;
  if (state.isPanning) {
    state.isPanning = false;
    state.panStart = null;
    canvasArea.classList.remove('panning');
  }
});

let pendingZoomDelta = 0;
let zoomRafScheduled = false;

canvasArea.addEventListener('wheel', e => {
  if (state.pages.length === 0) return;
  e.preventDefault();
  // Normalize delta: deltaMode 0=pixels, 1=lines (~40px), 2=pages (~800px)
  let delta = e.deltaY;
  if (e.deltaMode === 1) delta *= 40;
  if (e.deltaMode === 2) delta *= 800;
  // Proportional scaling: trackpad fires many small events, mouse fewer large ones
  const zoomDelta = -delta * 0.0015;
  pendingZoomDelta += Math.max(-0.1, Math.min(0.1, zoomDelta));
  if (!zoomRafScheduled) {
    zoomRafScheduled = true;
    requestAnimationFrame(() => {
      if (pendingZoomDelta !== 0) {
        adjustZoom(pendingZoomDelta);
        pendingZoomDelta = 0;
      }
      zoomRafScheduled = false;
    });
  }
}, { passive: false });

function hitTest(pos, radius = 12) {
  // pos is canvas-space; stored annotations are PDF-space.
  // Convert pos to PDF-space for comparison, and scale radius accordingly.
  const p = { x: pos.x / state.zoom, y: pos.y / state.zoom };
  const r = radius / state.zoom;
  const ann = state.pages[state.currentPage].annotations;
  // Check counter markers
  for (const [typeId, markers] of Object.entries(ann.counterMarkers)) {
    for (let i = 0; i < markers.length; i++) {
      if (ptDist(p, markers[i]) < r) return { type: 'marker', typeId, index: i };
    }
  }
  // Check quick lines
  for (let i = 0; i < ann.quickLines.length; i++) {
    const l = ann.quickLines[i];
    const d = distToSegment(p, {x:l.x1,y:l.y1}, {x:l.x2,y:l.y2});
    if (d < r) return { type: 'quickLine', index: i };
  }
  // Check polylines
  for (let pi = 0; pi < ann.polylines.length; pi++) {
    const poly = ann.polylines[pi];
    for (let j = 0; j < poly.points.length - 1; j++) {
      if (distToSegment(p, poly.points[j], poly.points[j+1]) < r) return { type: 'polyline', index: pi };
    }
  }
  return null;
}

function distToSegment(p, a, b) {
  const dx = b.x - a.x, dy = b.y - a.y;
  if (dx === 0 && dy === 0) return ptDist(p, a);
  const t = Math.max(0, Math.min(1, ((p.x - a.x) * dx + (p.y - a.y) * dy) / (dx*dx + dy*dy)));
  return ptDist(p, { x: a.x + t*dx, y: a.y + t*dy });
}

function contextDelete() {
  const t = state.ctxTarget;
  if (!t) return;
  const ann = state.pages[state.currentPage].annotations;
  if (t.type === 'marker') {
    ann.counterMarkers[t.typeId].splice(t.index, 1);
  } else if (t.type === 'quickLine') {
    ann.quickLines.splice(t.index, 1);
  } else if (t.type === 'polyline') {
    ann.polylines.splice(t.index, 1);
  }
  state.ctxTarget = null;
  redraw();
  renderCounterList();
  renderLineTypeList();
  renderPolyList();
  updateSummary();
  saveToStorage();
}

function contextClosePoly() {}

function finishPolyline(closed) {
  if (!state.drawingPolyline || state.drawingPolyline.points.length < 2) return;
  state.drawingPolyline.closed = closed;
  const ann = state.pages[state.currentPage].annotations;
  ann.polylines.push({ ...state.drawingPolyline });
  state.drawingPolyline = null;
  setTool(TOOL.NONE);
  redraw();
  renderLineTypeList();
  renderPolyList();
  updateSummary();
  saveToStorage();
}

function selectLineItem(id, isPoly) {
  const isSame = state.selectedLineId === id && state.selectedLineIsPoly === isPoly;
  state.selectedLineId = isSame ? null : id;
  state.selectedLineIsPoly = isSame ? false : isPoly;
  renderPolyList();
  redraw();
}

function enterEditMode(polyId) {
  // If already editing something else, save it first
  if (state.editingPolyline) exitEditMode(true);

  const ann = state.pages[state.currentPage].annotations;
  const idx = ann.polylines.findIndex(p => p.id === polyId);
  if (idx === -1) return;

  // Deep-copy so edits can be cancelled cleanly
  state.editingPolyline = JSON.parse(JSON.stringify(ann.polylines[idx]));
  state.editingPolyIndex = idx;
  state.draggingVertexIdx = null;

  // Remove from the saved array while editing (redrawn separately)
  ann.polylines.splice(idx, 1);

  setTool(TOOL.EDIT_POLY);
  setStatus('Drag vertices to move · Right-click vertex to delete · Done or Escape to finish');
  redraw();
  renderPolyList();
}

function exitEditMode(save) {
  if (!state.editingPolyline) return;
  const ann = state.pages[state.currentPage].annotations;

  if (save && state.editingPolyline.points.length >= 2) {
    // Reinsert at original position (or append if list shrank)
    const insertAt = Math.min(state.editingPolyIndex, ann.polylines.length);
    ann.polylines.splice(insertAt, 0, state.editingPolyline);
  }

  state.editingPolyline = null;
  state.editingPolyIndex = null;
  state.draggingVertexIdx = null;

  setTool(TOOL.NONE);
  redraw();
  renderLineTypeList();
  renderPolyList();
  updateSummary();
  saveToStorage();
}

// ─── TOOL MANAGEMENT ──────────────────────────────────────────────────────────
function setTool(tool) {
  state.tool = tool;
  // Clear all active states
  ['btn-scale','btn-line','btn-polyline','btn-counter'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove('active');
  });
  document.getElementById('canvas-area').className = 'canvas-area';
  if (tool === TOOL.SCALE) {
    document.getElementById('btn-scale').classList.add('active');
    document.getElementById('canvas-area').classList.add('mode-scale');
  } else if (tool === TOOL.LINE) {
    document.getElementById('btn-line').classList.add('active');
    document.getElementById('canvas-area').classList.add('mode-line');
  } else if (tool === TOOL.POLYLINE) {
    document.getElementById('btn-polyline').classList.add('active');
    document.getElementById('canvas-area').classList.add('mode-polyline');
  } else if (tool === TOOL.COUNTER) {
    document.getElementById('btn-counter').classList.add('active');
    document.getElementById('canvas-area').classList.add('mode-counter');
  } else if (tool === TOOL.EDIT_POLY) {
    document.getElementById('canvas-area').classList.add('mode-edit_poly');
  }
  document.getElementById('btn-done-edit').style.display = tool === TOOL.EDIT_POLY ? '' : 'none';
  const canvasArea = document.getElementById('canvas-area');
  if (tool === TOOL.NONE) {
    setStatus('No tool active · Drag to pan');
    hideHUD();
    canvasArea.classList.add('mode-pan');
  } else {
    canvasArea.classList.remove('mode-pan', 'panning');
  }
}

// ─── PAGE NAVIGATION ──────────────────────────────────────────────────────────
function gotoPage(idx) {
  if (idx < 0 || idx >= state.pages.length) return;
  state.currentPage = idx;
  state.selectedLineId = null;
  state.selectedLineIsPoly = false;
  renderCurrentPage();
  renderCounterList();
  renderLineTypeList();
  renderPolyList();
  updateSummary();
}

function updateNav() {
  const nav = document.getElementById('page-nav');
  if (state.pages.length <= 1) { nav.style.display = 'none'; } else { nav.style.display = 'flex'; }
  document.getElementById('nav-label').textContent = `Page ${state.currentPage + 1} of ${state.pages.length}`;
  document.getElementById('nav-prev').disabled = state.currentPage === 0;
  document.getElementById('nav-next').disabled = state.currentPage === state.pages.length - 1;
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (state.tool === TOOL.EDIT_POLY) { exitEditMode(true); return; }
    setTool(TOOL.NONE); state.drawingPolyline = null; state.quickLineStart = null; redraw();
  }
  if (e.key === 'ArrowRight' || e.key === 'ArrowDown') gotoPage(state.currentPage + 1);
  if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') gotoPage(state.currentPage - 1);
  if (e.key === 'Enter' && state.tool === TOOL.POLYLINE) finishPolyline(false);
  if (e.key === 'Enter' && state.tool === TOOL.EDIT_POLY) exitEditMode(true);
});

// ─── SIDEBAR RENDERS ──────────────────────────────────────────────────────────
function startInlineRename(spanEl, currentValue, onSave) {
  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentValue;
  input.className = 'inline-rename-input';
  input.style.cssText = 'width:100%;font-size:12px;padding:2px 4px;border:1px solid var(--accent);border-radius:4px;background:var(--surface2);color:var(--text);';
  spanEl.replaceWith(input);
  input.focus();
  input.select();
  const finish = (save) => {
    const newVal = (input.value.trim() || currentValue);
    if (save) onSave(newVal);
    spanEl.textContent = save ? newVal : currentValue;
    if (input.parentNode) input.replaceWith(spanEl);
  };
  input.onblur = () => finish(true);
  input.onkeydown = (e) => {
    if (e.key === 'Enter') { finish(true); e.preventDefault(); }
    if (e.key === 'Escape') { finish(false); e.preventDefault(); }
  };
}

function updatePageList() {
  const list = document.getElementById('page-list');
  list.innerHTML = '';
  state.pages.forEach((p, i) => {
    const hasAnn = hasAnnotations(p.annotations);
    const el = document.createElement('div');
    el.className = 'page-item' + (i === state.currentPage ? ' active' : '');
    const pageNum = document.createElement('span');
    pageNum.className = 'page-num';
    pageNum.textContent = i + 1;
    const pageName = document.createElement('span');
    pageName.className = 'page-name';
    pageName.textContent = p.label;
    pageName.ondblclick = (e) => {
      e.stopPropagation();
      startInlineRename(pageName, p.label, (val) => {
        state.pages[i].label = val;
        saveToStorage();
      });
    };
    el.appendChild(pageNum);
    el.appendChild(pageName);
    if (hasAnn) {
      const dot = document.createElement('span');
      dot.className = 'page-dot';
      el.appendChild(dot);
    }
    el.onclick = (e) => {
      if (e.target.closest('.page-name') || e.target.closest('.inline-rename-input')) return;
      gotoPage(i);
    };
    list.appendChild(el);
  });
}

function hasAnnotations(ann) {
  if (ann.quickLines.length > 0 || ann.polylines.length > 0) return true;
  return Object.values(ann.counterMarkers).some(m => m.length > 0);
}

function showCounterColorPicker(def, swatchEl) {
  const picker = document.getElementById('counter-color-picker');
  picker.innerHTML = '';
  const currentColor = def.color || COLORS[0];
  COLORS.forEach(c => {
    const el = document.createElement('div');
    el.className = 'color-swatch' + (c === currentColor ? ' selected' : '');
    el.style.background = c;
    el.onclick = (e) => {
      e.stopPropagation();
      def.color = c;
      swatchEl.style.background = c;
      picker.style.display = 'none';
      document.removeEventListener('click', closePicker);
      renderCounterList();
      redraw();
      saveToStorage();
    };
    picker.appendChild(el);
  });
  const rect = swatchEl.getBoundingClientRect();
  picker.style.left = rect.left + 'px';
  picker.style.top = (rect.bottom + 4) + 'px';
  picker.style.display = 'flex';
  function closePicker() {
    picker.style.display = 'none';
    document.removeEventListener('click', closePicker);
  }
  setTimeout(() => document.addEventListener('click', closePicker), 0);
}

function renderCounterList() {
  const list = document.getElementById('counter-list');
  list.innerHTML = '';
  if (state.counters.length === 0) {
    list.innerHTML = '<div style="padding:10px 12px;font-size:11px;color:var(--text3)">No counters yet</div>';
    return;
  }
  state.counters.forEach(def => {
    const count = (state.pages.length > 0 && state.pages[state.currentPage].annotations.counterMarkers[def.id]) ?
      state.pages[state.currentPage].annotations.counterMarkers[def.id].length : 0;
    const el = document.createElement('div');
    el.className = 'counter-item' + (state.tool === TOOL.COUNTER && state.activeCounterType === def.id ? ' active' : '');
    const iconSpan = document.createElement('span');
    iconSpan.className = 'counter-icon';
    iconSpan.innerHTML = renderIconHtml(def.icon);
    const counterInfo = document.createElement('div');
    counterInfo.className = 'counter-info';
    const counterName = document.createElement('div');
    counterName.className = 'counter-name';
    counterName.textContent = def.name;
    counterName.ondblclick = (e) => {
      e.stopPropagation();
      startInlineRename(counterName, def.name, (val) => {
        def.name = val;
        saveToStorage();
      });
    };
    counterInfo.appendChild(counterName);
    const countSpan = document.createElement('span');
    countSpan.className = 'counter-count';
    countSpan.textContent = count;
    const colorSpan = document.createElement('span');
    colorSpan.className = 'counter-swatch';
    colorSpan.style.background = def.color || COLORS[0];
    el.appendChild(iconSpan);
    el.appendChild(colorSpan);
    el.appendChild(counterInfo);
    el.appendChild(countSpan);
    el.onclick = (e) => {
      if (e.target.closest('.counter-name') || e.target.closest('.counter-swatch') || e.target.closest('.inline-rename-input')) return;
      activateCounter(def.id);
    };
    colorSpan.onclick = (e) => {
      e.stopPropagation();
      showCounterColorPicker(def, colorSpan);
    };
    list.appendChild(el);
  });
}

function renderPolyList() {
  const list = document.getElementById('poly-list');
  list.innerHTML = '';
  if (state.pages.length === 0) return;
  const ann = state.pages[state.currentPage].annotations;

  const quickItems = ann.quickLines.map(l => ({
    name: l.name || 'Quick Line',
    color: l.color,
    dist: ptDist({x:l.x1,y:l.y1},{x:l.x2,y:l.y2}),
    id: l.id,
    isPoly: false,
    lineTypeId: l.lineTypeId || null,
  }));
  const polyItems = ann.polylines.map(p => ({
    name: p.name,
    color: p.color,
    dist: polylineDistance(p.points, p.closed),
    id: p.id,
    isPoly: true,
    lineTypeId: p.lineTypeId || null,
  }));
  if (state.editingPolyline) {
    polyItems.push({
      name: state.editingPolyline.name,
      color: state.editingPolyline.color,
      dist: polylineDistance(state.editingPolyline.points, state.editingPolyline.closed),
      id: state.editingPolyline.id,
      isPoly: true,
      isEditing: true,
      lineTypeId: state.editingPolyline.lineTypeId || null,
    });
  }
  const all = [...quickItems, ...polyItems];

  if (all.length === 0) {
    list.innerHTML = '<div style="padding:10px 12px;font-size:11px;color:var(--text3)">No lines yet</div>';
    return;
  }

  // Group by lineTypeId
  const groups = {};
  all.forEach(item => {
    const key = item.lineTypeId || '__ungrouped__';
    if (!groups[key]) groups[key] = [];
    groups[key].push(item);
  });

  const orderedKeys = [...state.lineTypes.map(l => l.id).filter(k => groups[k]), '__ungrouped__'];
  Object.keys(groups).filter(k => !orderedKeys.includes(k)).forEach(k => orderedKeys.push(k));

  orderedKeys.forEach(key => {
    const items = groups[key];
    if (!items) return;
    const typeName = key === '__ungrouped__' ? 'Ungrouped' : (state.lineTypes.find(l => l.id === key)?.name || 'Unknown');
    const totalLen = items.reduce((a, i) => a + i.dist, 0);
    const header = document.createElement('div');
    header.className = 'poly-group-header';
    header.style.cssText = 'font-size:10px;color:var(--text3);padding:4px 12px;font-weight:600;border-bottom:1px solid var(--surface2);';
    header.textContent = `${typeName} — ${items.length} run${items.length !== 1 ? 's' : ''}, ${formatDist(totalLen)}`;
    list.appendChild(header);
    items.forEach(item => {
      const el = document.createElement('div');
      const isActiveEdit = item.isEditing || (state.editingPolyline && state.editingPolyline.id === item.id);
      const isSelected = state.selectedLineId === item.id && state.selectedLineIsPoly === item.isPoly;
      el.className = 'poly-item' + (isActiveEdit || isSelected ? ' active' : '');
      const swatch = document.createElement('div');
      swatch.className = 'poly-swatch';
      swatch.style.background = item.color;
      const nameSpan = document.createElement('span');
      nameSpan.className = 'poly-name';
      nameSpan.textContent = item.name;
      nameSpan.ondblclick = (e) => {
        e.stopPropagation();
        const target = item.isPoly
          ? (state.editingPolyline && state.editingPolyline.id === item.id ? state.editingPolyline : ann.polylines.find(p => p.id === item.id))
          : ann.quickLines.find(l => l.id === item.id);
        if (!target) return;
        startInlineRename(nameSpan, item.name, (val) => {
          target.name = val;
          renderPolyList();
          redraw();
          saveToStorage();
        });
      };
      const distSpan = document.createElement('span');
      distSpan.className = 'poly-dist';
      distSpan.textContent = formatDist(item.dist);
      el.appendChild(swatch);
      el.appendChild(nameSpan);
      el.appendChild(distSpan);
      if (item.isPoly) {
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-poly-btn';
        editBtn.title = 'Edit vertices';
        editBtn.textContent = '\u270E';
        editBtn.onclick = (e) => { e.stopPropagation(); enterEditMode(item.id); };
        el.appendChild(editBtn);
      }
      el.onclick = (e) => {
        if (e.target.closest('.edit-poly-btn') || e.target.closest('.poly-name') || e.target.closest('.inline-rename-input')) return;
        selectLineItem(item.id, item.isPoly);
      };
      list.appendChild(el);
    });
  });
}

// ─── SUMMARY ────────────────────────────────────────────────────────────────
function updateSummary() {
  if (state.pages.length === 0) return;
  const section = document.getElementById('summary-section');
  const content = document.getElementById('summary-content');
  const ann = state.pages[state.currentPage].annotations;
  const rows = [];
  state.counters.forEach(def => {
    const count = (ann.counterMarkers[def.id] || []).length;
    if (count > 0) rows.push(`<div class="summary-row"><span>${renderIconHtml(def.icon)} ${def.name}</span><span>${count}</span></div>`);
  });
  let totalDist = 0;
  const typeStats = {};
  ann.quickLines.forEach(l => {
    const d = ptDist({x:l.x1,y:l.y1},{x:l.x2,y:l.y2});
    totalDist += d;
    const k = l.lineTypeId || '__ungrouped__';
    if (!typeStats[k]) typeStats[k] = { runs: 0, length: 0 };
    typeStats[k].runs++;
    typeStats[k].length += d;
  });
  ann.polylines.forEach(p => {
    const d = polylineDistance(p.points, p.closed);
    totalDist += d;
    const k = p.lineTypeId || '__ungrouped__';
    if (!typeStats[k]) typeStats[k] = { runs: 0, length: 0 };
    typeStats[k].runs++;
    typeStats[k].length += d;
  });
  const lineTypeIds = state.lineTypes.map(l => l.id);
  const ordered = [
    ...lineTypeIds.filter(k => typeStats[k]),
    ...(typeStats['__ungrouped__'] ? ['__ungrouped__'] : []),
    ...Object.keys(typeStats).filter(k => !lineTypeIds.includes(k) && k !== '__ungrouped__')
  ];
  ordered.forEach(k => {
    const s = typeStats[k];
    const name = k === '__ungrouped__' ? 'Ungrouped' : (state.lineTypes.find(l => l.id === k)?.name || 'Unknown');
    rows.push(`<div class="summary-row"><span>${name}</span><span>${s.runs} run${s.runs !== 1 ? 's' : ''}, ${formatDist(s.length)}</span></div>`);
  });
  if (totalDist > 0 && Object.keys(typeStats).length > 1) rows.push(`<div class="summary-row"><span>Total Length</span><span>${formatDist(totalDist)}</span></div>`);
  if (rows.length > 0) {
    section.style.display = '';
    content.innerHTML = rows.join('');
  } else { section.style.display = 'none'; }
}

// ─── STATUS ───────────────────────────────────────────────────────────────────
function setStatus(msg) {
  document.getElementById('status-mode').textContent = msg;
}

// ─── MODAL HELPERS ────────────────────────────────────────────────────────────
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// Icon search filter
document.getElementById('icon-search').addEventListener('input', () => { renderIconGrid(); });

// Scale modal live preview
document.getElementById('scale-value').addEventListener('input', () => {
  const val = parseFloat(document.getElementById('scale-value').value);
  const unit = document.getElementById('scale-unit').value;
  const preview = document.getElementById('scale-preview');
  if (state.scalePointA && state.scalePointB && val > 0) {
    const pdfPts = ptDist(state.scalePointA, state.scalePointB);
    const ppu = pdfPts / val;
    preview.textContent = `1 ${unit} = ${ppu.toFixed(2)} pdf-pts`;
  } else { preview.textContent = 'Enter a value above to preview scale'; }
});

// ─── FILE UPLOAD ──────────────────────────────────────────────────────────────
document.getElementById('file-input').addEventListener('change', async e => {
  const files = Array.from(e.target.files);
  for (const f of files) await loadPDFFile(f);
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('canvas-wrapper').style.display = '';
  // Init counter marker arrays for new pages
  state.counters.forEach(def => {
    state.pages.forEach(p => {
      if (!p.annotations.counterMarkers[def.id]) p.annotations.counterMarkers[def.id] = [];
    });
  });
  state.currentPage = 0;
  fitToView();
  renderCurrentPage();
  renderCounterList();
  updateSummary();
  setTool(TOOL.NONE);  // ensure pan mode cursor when no tool active
  e.target.value = '';
});

// ─── CLEAR PAGE ────────────────────────────────────────────────────────────
function clearPage() {
  if (!confirm('Clear all annotations on this page?')) return;
  state.pages[state.currentPage].annotations = makeAnnotations();
  state.counters.forEach(def => {
    state.pages[state.currentPage].annotations.counterMarkers[def.id] = [];
  });
  redraw();
  renderCounterList();
  renderLineTypeList();
  renderPolyList();
  updateSummary();
  saveToStorage();
}

// ─── EXPORT / IMPORT ──────────────────────────────────────────────────────────
function exportProject() {
  const data = {
    version: 1,
    scale: state.scale,
    counters: state.counters,
    lineTypes: state.lineTypes,
    pages: state.pages.map((p, i) => ({
      index: i,
      label: p.label,
      annotations: p.annotations
    }))
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'takeoff-project.json';
  a.click();
}

function importProject(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const data = JSON.parse(ev.target.result);
    if (data.scale) state.scale = data.scale;
    if (data.counters) state.counters = data.counters;
    if (data.lineTypes) state.lineTypes = data.lineTypes;
    if (data.pages) {
      data.pages.forEach((pd, i) => {
        if (state.pages[i]) state.pages[i].annotations = pd.annotations;
      });
    }
    if (state.scale) {
      document.getElementById('scale-display').textContent = `Scale: 1 ${state.scale.unit} = ${state.scale.pixelsPerUnit.toFixed(1)} px`;
      document.getElementById('scale-display').style.display = '';
    }
    redraw();
    renderCounterList();
    renderLineTypeList();
    renderPolyList();
    updateSummary();
    updatePageList();
    saveToStorage();
  };
  reader.readAsText(file);
  e.target.value = '';
}

// ─── LOCAL STORAGE ───────────────────────────────────────────────────────────
function saveToStorage() {
  try {
    const data = {
      scale: state.scale,
      counters: state.counters,
      lineTypes: state.lineTypes,
      pageAnnotations: state.pages.map(p => p.annotations)
    };
    localStorage.setItem('takeoff-state', JSON.stringify(data));
  } catch(e) {}
}

// ─── UID ──────────────────────────────────────────────────────────────────────
function uid() { return Math.random().toString(36).slice(2, 10); }

// ─── INIT ─────────────────────────────────────────────────────────────────────
(function init() {
  updateZoomLabel();
  renderCounterList();
  renderPolyList();
  // Restore scale from storage
  try {
    const saved = JSON.parse(localStorage.getItem('takeoff-state'));
    if (saved && saved.scale) {
      state.scale = saved.scale;
      document.getElementById('scale-display').textContent = `Scale: 1 ${state.scale.unit} = ${state.scale.pixelsPerUnit.toFixed(1)} px`;
      document.getElementById('scale-display').style.display = '';
    }
    if (saved && saved.counters) state.counters = saved.counters;
    if (saved && saved.lineTypes) state.lineTypes = saved.lineTypes;
  } catch(e) {}
  renderLineTypeList();
})();
</script>
<script src="report.js"></script>
</body>
</html>
