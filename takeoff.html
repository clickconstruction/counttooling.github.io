<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClickCount â€” PDF Measurement & Counting Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f11;
    --surface: #17171a;
    --surface2: #1e1e22;
    --surface3: #26262c;
    --border: #2e2e36;
    --border2: #3a3a44;
    --accent: #e8c547;
    --accent2: #c9a82e;
    --text: #f0ede8;
    --text2: #9e9b96;
    --text3: #5e5c58;
    --red: #e85447;
    --blue: #4a9eff;
    --green: #47c88e;
    --purple: #a47fff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    height: 52px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 16px;
    flex-shrink: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'Instrument Serif', serif;
    font-size: 18px;
    color: var(--accent);
    letter-spacing: -0.02em;
    margin-right: 8px;
    white-space: nowrap;
  }

  .logo span { color: var(--text2); font-style: italic; font-size: 14px; }

  .header-divider { width: 1px; height: 24px; background: var(--border); }

  .tool-btn {
    height: 32px;
    padding: 0 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tool-btn:hover { border-color: var(--border2); color: var(--text); background: var(--surface3); }
  .tool-btn.active { background: var(--accent); border-color: var(--accent); color: #000; }
  .tool-btn.danger { color: var(--red); border-color: var(--red)33; }
  .tool-btn.danger:hover { background: var(--red)22; }

  .scale-badge {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    background: var(--accent)15;
    border: 1px solid var(--accent)33;
    border-radius: 4px;
    padding: 3px 8px;
    white-space: nowrap;
  }

  .spacer { flex: 1; }

  /* â”€â”€ LAYOUT â”€â”€ */
  .app-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* â”€â”€ LEFT SIDEBAR â”€â”€ */
  .sidebar {
    width: 220px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
  }

  .sidebar-section {
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text3);
  }

  .sidebar-add {
    width: 20px; height: 20px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text3);
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .sidebar-add:hover { border-color: var(--accent); color: var(--accent); }

  /* Page list */
  .page-list { max-height: 200px; overflow-y: auto; }
  .page-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    gap: 8px;
    transition: background 0.1s;
    border-left: 2px solid transparent;
  }
  .page-item:hover { background: var(--surface2); }
  .page-item.active { background: var(--surface2); border-left-color: var(--accent); }
  .page-num {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text3);
    width: 20px;
  }
  .page-name { font-size: 12px; flex: 1; color: var(--text2); }
  .page-item.active .page-name { color: var(--text); }
  .page-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); opacity: 0.6; }

  /* Counter list */
  .counter-list { max-height: 220px; overflow-y: auto; }
  .counter-item {
    display: flex;
    align-items: center;
    padding: 7px 12px;
    gap: 8px;
    cursor: pointer;
    border-left: 2px solid transparent;
    transition: background 0.1s;
  }
  .counter-item:hover { background: var(--surface2); }
  .counter-item.active { background: var(--surface2); border-left-color: var(--accent); }
  .counter-icon { font-size: 14px; width: 20px; text-align: center; }
  .counter-info { flex: 1; min-width: 0; }
  .counter-name { font-size: 12px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .counter-item.active .counter-name { color: var(--text); }
  .counter-count {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    background: var(--accent)15;
    border-radius: 3px;
    padding: 1px 5px;
  }

  /* Polyline list */
  .poly-list { max-height: 180px; overflow-y: auto; flex: 1; overflow-y: auto; }
  .poly-item {
    display: flex;
    align-items: center;
    padding: 7px 12px;
    gap: 8px;
    cursor: pointer;
    border-left: 2px solid transparent;
    transition: background 0.1s;
  }
  .poly-item:hover { background: var(--surface2); }
  .poly-item.active { background: var(--surface2); border-left-color: var(--accent); }
  .poly-swatch { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }
  .poly-name { font-size: 12px; color: var(--text2); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .poly-dist {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text3);
  }

  /* Summary section */
  .summary-section {
    margin-top: auto;
    border-top: 1px solid var(--border);
    padding: 10px 12px;
  }
  .summary-title {
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 8px;
    font-weight: 600;
  }
  .summary-row {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text2);
    padding: 2px 0;
  }
  .summary-row span:last-child { font-family: 'DM Mono', monospace; color: var(--accent); }

  /* â”€â”€ CANVAS AREA â”€â”€ */
  .canvas-area {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #0a0a0c;
    background-image: radial-gradient(circle at 1px 1px, #1e1e22 1px, transparent 0);
    background-size: 24px 24px;
  }

  #canvas-wrapper {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 0 1px var(--border), 0 24px 80px rgba(0,0,0,0.6);
  }

  #pdf-canvas {
    display: block;
    background: white;
  }

  #annotation-canvas {
    position: absolute;
    top: 0; left: 0;
    pointer-events: all;
  }

  .empty-state {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }
  .empty-state h2 {
    font-family: 'Instrument Serif', serif;
    font-size: 28px;
    color: var(--text3);
    margin-bottom: 8px;
  }
  .empty-state p { font-size: 13px; color: var(--text3); margin-bottom: 20px; }
  .upload-big {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: var(--accent);
    color: #000;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    border: none;
    font-family: 'DM Sans', sans-serif;
    transition: background 0.15s;
  }
  .upload-big:hover { background: var(--accent2); }

  /* Zoom controls */
  .zoom-controls {
    position: absolute;
    bottom: 16px;
    right: 16px;
    display: flex;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px;
  }
  .zoom-btn {
    width: 28px; height: 28px;
    border-radius: 5px;
    border: none;
    background: transparent;
    color: var(--text2);
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.1s;
  }
  .zoom-btn:hover { background: var(--surface3); color: var(--text); }
  .zoom-level { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text3); padding: 0 6px; display: flex; align-items: center; }

  /* Cursor HUD */
  #hud {
    position: absolute;
    pointer-events: none;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 4px 8px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    display: none;
    white-space: nowrap;
    z-index: 50;
  }

  /* â”€â”€ MODALS â”€â”€ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    min-width: 360px;
    max-width: 440px;
    width: 90vw;
    transform: translateY(8px);
    transition: transform 0.2s;
    box-shadow: 0 24px 80px rgba(0,0,0,0.5);
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-title {
    font-family: 'Instrument Serif', serif;
    font-size: 22px;
    margin-bottom: 4px;
    color: var(--text);
  }
  .modal-subtitle { font-size: 12px; color: var(--text3); margin-bottom: 20px; }

  .form-group { margin-bottom: 16px; }
  .form-label { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text3); margin-bottom: 6px; display: block; }

  .form-input {
    width: 100%;
    height: 38px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    padding: 0 12px;
    outline: none;
    transition: border-color 0.15s;
  }
  .form-input:focus { border-color: var(--accent); }

  .form-row { display: flex; gap: 8px; }
  .form-row .form-input { flex: 1; }

  select.form-input { cursor: pointer; }

  .icon-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 4px;
  }
  .icon-opt {
    aspect-ratio: 1;
    border-radius: 6px;
    border: 2px solid transparent;
    background: var(--surface2);
    cursor: pointer;
    font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.1s;
  }
  .icon-opt:hover { border-color: var(--border2); }
  .icon-opt.selected { border-color: var(--accent); background: var(--accent)15; }

  .color-row { display: flex; gap: 6px; align-items: center; }
  .color-swatch {
    width: 28px; height: 28px;
    border-radius: 6px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: transform 0.1s;
  }
  .color-swatch:hover { transform: scale(1.1); }
  .color-swatch.selected { border-color: var(--text); }

  .scale-preview {
    background: var(--surface2);
    border-radius: 6px;
    padding: 10px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--accent);
    margin-top: 8px;
    min-height: 34px;
    display: flex;
    align-items: center;
  }

  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }

  .btn-secondary {
    height: 36px;
    padding: 0 16px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.15s;
  }
  .btn-secondary:hover { background: var(--surface2); color: var(--text); }

  .btn-primary {
    height: 36px;
    padding: 0 20px;
    border-radius: 6px;
    border: none;
    background: var(--accent);
    color: #000;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    transition: background 0.15s;
  }
  .btn-primary:hover { background: var(--accent2); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

  /* scrollbars */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

  /* â”€â”€ PAGE NAV â”€â”€ */
  .page-nav {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 10px;
  }
  .page-nav button {
    width: 28px; height: 28px;
    border-radius: 5px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text2);
    cursor: pointer;
    font-size: 12px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.1s;
  }
  .page-nav button:hover:not(:disabled) { background: var(--surface3); color: var(--text); }
  .page-nav button:disabled { opacity: 0.3; cursor: not-allowed; }
  .page-nav span {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text3);
    min-width: 60px;
    text-align: center;
  }

  /* â”€â”€ CONTEXT MENU â”€â”€ */
  .ctx-menu {
    position: fixed;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 4px;
    z-index: 500;
    min-width: 140px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    display: none;
  }
  .ctx-item {
    padding: 7px 12px;
    font-size: 12px;
    color: var(--text2);
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.1s;
  }
  .ctx-item:hover { background: var(--surface3); color: var(--text); }
  .ctx-item.danger { color: var(--red); }
  .ctx-item.danger:hover { background: var(--red)15; }

  /* â”€â”€ STATUS BAR â”€â”€ */
  .status-bar {
    height: 24px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 16px;
    flex-shrink: 0;
  }
  .status-item {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--text3);
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .status-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); }

  /* tool mode cursor */
  .mode-scale #annotation-canvas,
  .mode-line #annotation-canvas,
  .mode-polyline #annotation-canvas,
  .mode-counter #annotation-canvas { cursor: crosshair; }

  /* Tooltip */
  [title] { position: relative; }
</style>
</head>
<body>

<!-- â•â•â• HEADER â•â•â• -->
<header>
  <div class="logo">ClickCount</div>
  <div class="header-divider"></div>

  <button class="tool-btn" id="btn-upload" onclick="document.getElementById('file-input').click()">
    â†‘ Upload PDF
  </button>
  <input type="file" id="file-input" accept=".pdf" style="display:none" multiple>

  <div class="header-divider"></div>

  <button class="tool-btn" id="btn-scale" onclick="startScaleMode()">
    â— Set Scale
  </button>

  <div id="scale-display" class="scale-badge" style="display:none"></div>

  <div class="header-divider"></div>

  <button class="tool-btn" id="btn-line" onclick="startLineMode()" title="Draw a single measurement line">
    â•± Quick Line
  </button>

  <button class="tool-btn" id="btn-polyline" onclick="openPolylineModal()" title="Draw a multi-segment polyline">
    â†— Polyline
  </button>

  <button class="tool-btn" id="btn-counter" onclick="openCounterModal()" title="Add a new counter type">
    âŠ• Counter
  </button>

  <div class="spacer"></div>

  <button class="tool-btn" id="btn-export" onclick="exportProject()">â†“ Export</button>
  <button class="tool-btn" onclick="document.getElementById('import-input').click()">â†‘ Import</button>
  <input type="file" id="import-input" accept=".json" style="display:none" onchange="importProject(event)">

  <div class="header-divider"></div>
  <button class="tool-btn danger" onclick="clearPage()">âœ• Clear Page</button>
</header>

<!-- â•â•â• BODY â•â•â• -->
<div class="app-body">

  <!-- â”€â”€ LEFT SIDEBAR â”€â”€ -->
  <div class="sidebar">

    <!-- Pages -->
    <div class="sidebar-section">
      <div class="sidebar-header">
        Pages
        <button class="sidebar-add" onclick="document.getElementById('file-input').click()" title="Add more PDFs">+</button>
      </div>
      <div class="page-list" id="page-list"></div>
    </div>

    <!-- Counters -->
    <div class="sidebar-section">
      <div class="sidebar-header">
        Counters
        <button class="sidebar-add" onclick="openCounterModal()" title="New counter">+</button>
      </div>
      <div class="counter-list" id="counter-list"></div>
    </div>

    <!-- Polylines -->
    <div class="sidebar-section" style="flex:1; display:flex; flex-direction:column; overflow:hidden">
      <div class="sidebar-header">
        Lines
        <button class="sidebar-add" onclick="openPolylineModal()" title="New polyline">+</button>
      </div>
      <div class="poly-list" id="poly-list"></div>
    </div>

    <!-- Summary -->
    <div class="summary-section" id="summary-section" style="display:none">
      <div class="summary-title">Page Summary</div>
      <div id="summary-content"></div>
    </div>

  </div>

  <!-- â”€â”€ CANVAS AREA â”€â”€ -->
  <div class="canvas-area" id="canvas-area">

    <div class="empty-state" id="empty-state">
      <h2>No document loaded</h2>
      <p>Upload a PDF to get started</p>
      <button class="upload-big" onclick="document.getElementById('file-input').click()">
        â†‘ Upload PDF
      </button>
    </div>

    <div id="canvas-wrapper" style="display:none">
      <canvas id="pdf-canvas"></canvas>
      <canvas id="annotation-canvas"></canvas>
    </div>

    <div id="hud"></div>

    <!-- Page nav -->
    <div class="page-nav" id="page-nav" style="display:none">
      <button id="nav-prev" onclick="gotoPage(state.currentPage - 1)">â€¹</button>
      <span id="nav-label">Page 1 of 1</span>
      <button id="nav-next" onclick="gotoPage(state.currentPage + 1)">â€º</button>
    </div>

    <!-- Zoom controls -->
    <div class="zoom-controls">
      <button class="zoom-btn" onclick="adjustZoom(-0.25)">âˆ’</button>
      <div class="zoom-level" id="zoom-label">100%</div>
      <button class="zoom-btn" onclick="adjustZoom(0.25)">+</button>
      <button class="zoom-btn" onclick="fitToView()" title="Fit to view">âŠ¡</button>
    </div>

  </div>

</div>

<!-- Status bar -->
<div class="status-bar">
  <div class="status-item"><div class="status-dot"></div> Ready</div>
  <div class="status-item" id="status-mode">No tool active</div>
  <div class="status-item" id="status-coords"></div>
</div>

<!-- Context menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item danger" id="ctx-delete" onclick="contextDelete()">Delete</div>
  <div class="ctx-item" id="ctx-close-poly" onclick="contextClosePoly()" style="display:none">Close Polyline</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Scale Modal -->
<div class="modal-overlay" id="modal-scale">
  <div class="modal">
    <div class="modal-title">Set Drawing Scale</div>
    <div class="modal-subtitle" id="scale-px-info">You selected a line spanning â€” pixels.</div>
    <div class="form-group">
      <label class="form-label">This distance represents</label>
      <div class="form-row">
        <input class="form-input" type="number" id="scale-value" placeholder="e.g. 25" min="0.001" step="any">
        <select class="form-input" id="scale-unit" style="flex: 0 0 90px">
          <option value="ft">ft</option>
          <option value="in">in</option>
          <option value="m">m</option>
          <option value="cm">cm</option>
          <option value="yd">yd</option>
        </select>
      </div>
    </div>
    <div class="scale-preview" id="scale-preview">Enter a value above to preview scale</div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('modal-scale')">Cancel</button>
      <button class="btn-primary" id="btn-confirm-scale" onclick="confirmScale()">Set Scale</button>
    </div>
  </div>
</div>

<!-- Counter Modal -->
<div class="modal-overlay" id="modal-counter">
  <div class="modal">
    <div class="modal-title">New Counter</div>
    <div class="modal-subtitle">Create a counter type to place on the drawing</div>
    <div class="form-group">
      <label class="form-label">Name</label>
      <input class="form-input" type="text" id="counter-name" placeholder="e.g. Parking Spots">
    </div>
    <div class="form-group">
      <label class="form-label">Icon</label>
      <div class="icon-grid" id="icon-grid"></div>
    </div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div class="color-row" id="counter-color-row"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('modal-counter')">Cancel</button>
      <button class="btn-primary" onclick="confirmCounter()">Create Counter</button>
    </div>
  </div>
</div>

<!-- Polyline Modal -->
<div class="modal-overlay" id="modal-polyline">
  <div class="modal">
    <div class="modal-title">New Polyline</div>
    <div class="modal-subtitle">Name and style your measurement line</div>
    <div class="form-group">
      <label class="form-label">Name</label>
      <input class="form-input" type="text" id="poly-name" placeholder="e.g. North Fence Line">
    </div>
    <div class="form-group">
      <label class="form-label">Color</label>
      <div class="color-row" id="poly-color-row"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal('modal-polyline')">Cancel</button>
      <button class="btn-primary" onclick="confirmPolyline()">Start Drawing</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APPLICATION LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ICONS = ['ğŸ“','ğŸ”µ','ğŸ”´','ğŸŸ¡','ğŸŸ¢','ğŸŸ ','â­','ğŸ ','ğŸš—','ğŸŒ³','ğŸ”§','ğŸ’¡','ğŸªŸ','ğŸšª','ğŸ…¿ï¸','â™»ï¸','âš¡','ğŸ’§','ğŸ”¥','ğŸ›¢ï¸','ğŸ“¦','ğŸ–¥ï¸','ğŸ—ï¸','ğŸ”²'];
const COLORS = ['#e85447','#4a9eff','#e8c547','#47c88e','#a47fff','#ff7a47','#47d4d4','#ff47b0','#bfff47','#ffffff'];
const SCALE_MODES = { NONE: 0, POINT_A: 1, POINT_B: 2 };
const TOOL = { NONE: '', SCALE: 'scale', LINE: 'line', POLYLINE: 'polyline', COUNTER: 'counter' };

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  pages: [],          // [{ pdfData, annotations: { counters, polylines, quickLines, markers } }]
  currentPage: 0,
  scale: null,        // { pixelsPerUnit, unit, zoom } â€” stored at display zoom=1
  zoom: 1.0,
  tool: TOOL.NONE,
  scaleMode: SCALE_MODES.NONE,
  scalePointA: null,
  scalePointB: null,
  activeCounterType: null,   // counter definition id
  activePolylineId: null,
  drawingPolyline: null,     // { points: [], color, name, closed }
  quickLineStart: null,
  mousePos: { x: 0, y: 0 },
  counters: [],       // [{ id, name, icon, color }]
  ctxTarget: null,    // for right-click context
};

// Page annotations structure factory
function makeAnnotations() {
  return { counterMarkers: {}, polylines: [], quickLines: [] };
}

// â”€â”€â”€ PDF RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pdfCanvas = document.getElementById('pdf-canvas');
const annCanvas = document.getElementById('annotation-canvas');
const pdfCtx = pdfCanvas.getContext('2d');
const annCtx = annCanvas.getContext('2d');
let currentPdfPage = null;

async function loadPDFFile(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const label = file.name.replace('.pdf','') + (pdf.numPages > 1 ? ` â€” p${i}` : '');
    state.pages.push({ pdfPage: page, label, annotations: makeAnnotations() });
  }
}

async function renderCurrentPage() {
  if (state.pages.length === 0) return;
  const page = state.pages[state.currentPage];
  const viewport = page.pdfPage.getViewport({ scale: state.zoom });

  pdfCanvas.width = viewport.width;
  pdfCanvas.height = viewport.height;
  annCanvas.width = viewport.width;
  annCanvas.height = viewport.height;

  await page.pdfPage.render({ canvasContext: pdfCtx, viewport }).promise;
  redraw();
  updateNav();
  updatePageList();
}

function fitToView() {
  if (state.pages.length === 0) return;
  const area = document.getElementById('canvas-area');
  const page = state.pages[state.currentPage];
  const vp = page.pdfPage.getViewport({ scale: 1 });
  const scaleX = (area.clientWidth - 80) / vp.width;
  const scaleY = (area.clientHeight - 80) / vp.height;
  state.zoom = Math.min(scaleX, scaleY, 2);
  renderCurrentPage();
  updateZoomLabel();
}

function adjustZoom(delta) {
  state.zoom = Math.max(0.2, Math.min(4, state.zoom + delta));
  renderCurrentPage();
  updateZoomLabel();
}

function updateZoomLabel() {
  document.getElementById('zoom-label').textContent = Math.round(state.zoom * 100) + '%';
}

// â”€â”€â”€ CANVAS COORDINATE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function canvasPos(e) {
  const rect = annCanvas.getBoundingClientRect();
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

// â”€â”€â”€ REDRAW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function redraw() {
  const w = annCanvas.width, h = annCanvas.height;
  annCtx.clearRect(0, 0, w, h);
  if (state.pages.length === 0) return;
  const ann = state.pages[state.currentPage].annotations;

  // Draw quick lines
  for (const line of ann.quickLines) {
    drawLineAnnotation(line);
  }

  // Draw polylines
  for (const poly of ann.polylines) {
    drawPolylineAnnotation(poly);
  }

  // Draw counter markers
  for (const [typeId, markers] of Object.entries(ann.counterMarkers)) {
    const def = state.counters.find(c => c.id === typeId);
    if (!def) continue;
    markers.forEach((m, idx) => {
      drawMarker(m.x, m.y, def.icon, def.color, idx + 1);
    });
  }

  // Draw in-progress polyline
  if (state.drawingPolyline && state.drawingPolyline.points.length > 0) {
    const pts = state.drawingPolyline.points;
    const color = state.drawingPolyline.color;
    annCtx.strokeStyle = color;
    annCtx.lineWidth = 2;
    annCtx.setLineDash([6, 3]);
    annCtx.beginPath();
    annCtx.moveTo(pts[0].x, pts[0].y);
    for (let i = 1; i < pts.length; i++) annCtx.lineTo(pts[i].x, pts[i].y);
    annCtx.lineTo(state.mousePos.x, state.mousePos.y);
    annCtx.stroke();
    annCtx.setLineDash([]);
    // Draw vertices
    pts.forEach(p => {
      annCtx.beginPath();
      annCtx.arc(p.x, p.y, 4, 0, Math.PI * 2);
      annCtx.fillStyle = color;
      annCtx.fill();
    });
    // Running total HUD
    let dist = polylineDistance(pts) + ptDist(pts[pts.length-1], state.mousePos);
    updateHUD(`${formatDist(dist)} (running)`, state.mousePos.x + 16, state.mousePos.y);
  }

  // Draw scale in-progress
  if (state.scaleMode === SCALE_MODES.POINT_A || state.scaleMode === SCALE_MODES.POINT_B) {
    if (state.scalePointA) {
      annCtx.beginPath();
      annCtx.arc(state.scalePointA.x, state.scalePointA.y, 5, 0, Math.PI * 2);
      annCtx.fillStyle = '#fff';
      annCtx.fill();
      if (state.scaleMode === SCALE_MODES.POINT_B) {
        annCtx.strokeStyle = '#fff';
        annCtx.lineWidth = 1.5;
        annCtx.setLineDash([5,3]);
        annCtx.beginPath();
        annCtx.moveTo(state.scalePointA.x, state.scalePointA.y);
        annCtx.lineTo(state.mousePos.x, state.mousePos.y);
        annCtx.stroke();
        annCtx.setLineDash([]);
        const d = ptDist(state.scalePointA, state.mousePos);
        updateHUD(`${Math.round(d)} px`, state.mousePos.x + 16, state.mousePos.y);
      }
    }
  }

  // Quick line in progress
  if (state.tool === TOOL.LINE && state.quickLineStart) {
    annCtx.strokeStyle = '#fff';
    annCtx.lineWidth = 1.5;
    annCtx.setLineDash([5,3]);
    annCtx.beginPath();
    annCtx.moveTo(state.quickLineStart.x, state.quickLineStart.y);
    annCtx.lineTo(state.mousePos.x, state.mousePos.y);
    annCtx.stroke();
    annCtx.setLineDash([]);
    const d = ptDist(state.quickLineStart, state.mousePos);
    updateHUD(formatDist(d), state.mousePos.x + 16, state.mousePos.y);
  }
}

function drawLineAnnotation(line) {
  annCtx.strokeStyle = line.color || '#fff';
  annCtx.lineWidth = 1.5;
  annCtx.beginPath();
  annCtx.moveTo(line.x1, line.y1);
  annCtx.lineTo(line.x2, line.y2);
  annCtx.stroke();
  // endpoints
  [line.x1, line.x2].forEach((x, i) => {
    const y = i === 0 ? line.y1 : line.y2;
    annCtx.beginPath();
    annCtx.arc(x, y, 3.5, 0, Math.PI * 2);
    annCtx.fillStyle = line.color || '#fff';
    annCtx.fill();
  });
  // label
  const mx = (line.x1 + line.x2) / 2, my = (line.y1 + line.y2) / 2;
  const d = ptDist({x:line.x1,y:line.y1}, {x:line.x2,y:line.y2});
  drawLabel(formatDist(d), mx, my - 8, line.color || '#fff');
}

function drawPolylineAnnotation(poly) {
  if (!poly.points || poly.points.length < 2) return;
  const color = poly.color;
  annCtx.strokeStyle = color;
  annCtx.lineWidth = 2;
  annCtx.lineJoin = 'round';
  annCtx.beginPath();
  annCtx.moveTo(poly.points[0].x, poly.points[0].y);
  for (let i = 1; i < poly.points.length; i++) annCtx.lineTo(poly.points[i].x, poly.points[i].y);
  if (poly.closed) annCtx.closePath();
  annCtx.stroke();
  // vertices
  poly.points.forEach(p => {
    annCtx.beginPath();
    annCtx.arc(p.x, p.y, 4, 0, Math.PI * 2);
    annCtx.fillStyle = color;
    annCtx.fill();
  });
  // total label
  const total = polylineDistance(poly.points, poly.closed);
  const midPt = poly.points[Math.floor(poly.points.length / 2)];
  drawLabel(`${poly.name}: ${formatDist(total)}`, midPt.x, midPt.y - 14, color);
  if (poly.closed && state.scale) {
    const area = polygonArea(poly.points);
    drawLabel(`Area: ${formatArea(area)}`, midPt.x, midPt.y + 4, color + 'cc');
  }
}

function drawMarker(x, y, icon, color, num) {
  // Colored circle
  annCtx.beginPath();
  annCtx.arc(x, y, 14, 0, Math.PI * 2);
  annCtx.fillStyle = color + '44';
  annCtx.fill();
  annCtx.strokeStyle = color;
  annCtx.lineWidth = 1.5;
  annCtx.stroke();
  // Icon
  annCtx.font = '13px serif';
  annCtx.textAlign = 'center';
  annCtx.textBaseline = 'middle';
  annCtx.fillText(icon, x, y - 1);
  // Badge
  annCtx.beginPath();
  annCtx.arc(x + 10, y - 10, 7, 0, Math.PI * 2);
  annCtx.fillStyle = color;
  annCtx.fill();
  annCtx.font = 'bold 8px DM Sans, sans-serif';
  annCtx.fillStyle = '#000';
  annCtx.fillText(num, x + 10, y - 10);
  annCtx.textAlign = 'left';
  annCtx.textBaseline = 'alphabetic';
}

function drawLabel(text, x, y, color) {
  annCtx.font = '11px DM Mono, monospace';
  const w = annCtx.measureText(text).width;
  annCtx.fillStyle = 'rgba(15,15,17,0.75)';
  annCtx.fillRect(x - w/2 - 4, y - 9, w + 8, 16);
  annCtx.fillStyle = color;
  annCtx.textAlign = 'center';
  annCtx.fillText(text, x, y + 2);
  annCtx.textAlign = 'left';
}

// â”€â”€â”€ DISTANCE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ptDist(a, b) {
  return Math.sqrt((b.x - a.x) ** 2 + (b.y - a.y) ** 2);
}

function polylineDistance(pts, closed = false) {
  let d = 0;
  for (let i = 1; i < pts.length; i++) d += ptDist(pts[i-1], pts[i]);
  if (closed && pts.length > 2) d += ptDist(pts[pts.length-1], pts[0]);
  return d;
}

function polygonArea(pts) {
  let area = 0;
  for (let i = 0; i < pts.length; i++) {
    const j = (i + 1) % pts.length;
    area += pts[i].x * pts[j].y;
    area -= pts[j].x * pts[i].y;
  }
  return Math.abs(area) / 2;
}

function formatDist(pixels) {
  if (!state.scale) return `${Math.round(pixels)} px`;
  const real = (pixels / state.scale.pixelsPerUnit) / state.zoom;
  return `${real.toFixed(2)} ${state.scale.unit}`;
}

function formatArea(sqPixels) {
  if (!state.scale) return `${Math.round(sqPixels)} pxÂ²`;
  const ppu = state.scale.pixelsPerUnit / state.zoom;
  const real = sqPixels / (ppu * ppu);
  return `${real.toFixed(1)} ${state.scale.unit}Â²`;
}

// â”€â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHUD(text, x, y) {
  const hud = document.getElementById('hud');
  const rect = annCanvas.getBoundingClientRect();
  const container = document.getElementById('canvas-area').getBoundingClientRect();
  hud.style.display = 'block';
  hud.style.left = (rect.left - container.left + x) + 'px';
  hud.style.top = (rect.top - container.top + y) + 'px';
  hud.textContent = text;
}

function hideHUD() { document.getElementById('hud').style.display = 'none'; }

// â”€â”€â”€ SCALE TOOL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startScaleMode() {
  setTool(TOOL.SCALE);
  state.scaleMode = SCALE_MODES.POINT_A;
  state.scalePointA = null;
  state.scalePointB = null;
  setStatus('Click the first reference point on the drawing');
}

function confirmScale() {
  const val = parseFloat(document.getElementById('scale-value').value);
  const unit = document.getElementById('scale-unit').value;
  if (!val || val <= 0) return;
  const pixels = ptDist(state.scalePointA, state.scalePointB);
  // Store at zoom=1 equivalent
  state.scale = { pixelsPerUnit: (pixels / val) * state.zoom, unit };
  closeModal('modal-scale');
  document.getElementById('scale-display').textContent = `Scale: 1 ${unit} = ${(state.scale.pixelsPerUnit).toFixed(1)} px`;
  document.getElementById('scale-display').style.display = '';
  setTool(TOOL.NONE);
  redraw();
  saveToStorage();
}

// â”€â”€â”€ LINE TOOL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startLineMode() {
  if (!state.scale) {
    alert('Set a scale first using the "Set Scale" button.');
    return;
  }
  setTool(TOOL.LINE);
  state.quickLineStart = null;
  setStatus('Click to start a quick measurement line');
}

// â”€â”€â”€ POLYLINE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingPolyColor = COLORS[0];
function openPolylineModal() {
  if (!state.scale) { alert('Set a scale first.'); return; }
  document.getElementById('poly-name').value = '';
  renderColorRow('poly-color-row', 'pendingPolyColor');
  openModal('modal-polyline');
}

function confirmPolyline() {
  const name = document.getElementById('poly-name').value.trim() || 'Line';
  closeModal('modal-polyline');
  state.drawingPolyline = { id: uid(), name, color: pendingPolyColor, points: [], closed: false };
  setTool(TOOL.POLYLINE);
  setStatus('Click to add vertices. Double-click to finish. Right-click to close polygon.');
}

// â”€â”€â”€ COUNTER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingCounterIcon = ICONS[0];
let pendingCounterColor = COLORS[0];

function openCounterModal() {
  document.getElementById('counter-name').value = '';
  pendingCounterIcon = ICONS[0];
  pendingCounterColor = COLORS[0];
  renderIconGrid();
  renderColorRow('counter-color-row', 'pendingCounterColor');
  openModal('modal-counter');
}

function renderIconGrid() {
  const grid = document.getElementById('icon-grid');
  grid.innerHTML = '';
  ICONS.forEach(icon => {
    const el = document.createElement('div');
    el.className = 'icon-opt' + (icon === pendingCounterIcon ? ' selected' : '');
    el.textContent = icon;
    el.onclick = () => {
      pendingCounterIcon = icon;
      renderIconGrid();
    };
    grid.appendChild(el);
  });
}

function renderColorRow(id, varName) {
  const row = document.getElementById(id);
  row.innerHTML = '';
  COLORS.forEach(c => {
    const el = document.createElement('div');
    el.className = 'color-swatch' + (c === window[varName] ? ' selected' : '');
    el.style.background = c;
    el.onclick = () => { window[varName] = c; renderColorRow(id, varName); };
    row.appendChild(el);
  });
}

function confirmCounter() {
  const name = document.getElementById('counter-name').value.trim() || 'Counter';
  const def = { id: uid(), name, icon: pendingCounterIcon, color: pendingCounterColor };
  state.counters.push(def);
  // Init empty markers on all pages
  state.pages.forEach(p => { p.annotations.counterMarkers[def.id] = []; });
  closeModal('modal-counter');
  activateCounter(def.id);
  renderCounterList();
  saveToStorage();
}

function activateCounter(id) {
  state.activeCounterType = id;
  setTool(TOOL.COUNTER);
  const def = state.counters.find(c => c.id === id);
  setStatus(`Placing: ${def.icon} ${def.name} â€” click to count`);
  renderCounterList();
}

// â”€â”€â”€ CANVAS EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
annCanvas.addEventListener('mousemove', e => {
  const pos = canvasPos(e);
  state.mousePos = pos;
  document.getElementById('status-coords').textContent = `x:${Math.round(pos.x)} y:${Math.round(pos.y)}`;
  if (state.tool !== TOOL.NONE) redraw();
});

annCanvas.addEventListener('mouseleave', () => { hideHUD(); });

annCanvas.addEventListener('click', e => {
  if (e.button !== 0) return;
  const pos = canvasPos(e);

  if (state.tool === TOOL.SCALE) {
    if (state.scaleMode === SCALE_MODES.POINT_A) {
      state.scalePointA = pos;
      state.scaleMode = SCALE_MODES.POINT_B;
      setStatus('Now click the second reference point');
      redraw();
    } else if (state.scaleMode === SCALE_MODES.POINT_B) {
      state.scalePointB = pos;
      state.scaleMode = SCALE_MODES.NONE;
      const pixels = ptDist(state.scalePointA, state.scalePointB);
      document.getElementById('scale-px-info').textContent = `You selected a line spanning ${Math.round(pixels)} pixels.`;
      document.getElementById('scale-value').value = '';
      document.getElementById('scale-preview').textContent = 'Enter a value above to preview scale';
      openModal('modal-scale');
      redraw();
    }
    return;
  }

  if (state.tool === TOOL.LINE) {
    if (!state.quickLineStart) {
      state.quickLineStart = pos;
    } else {
      const ann = state.pages[state.currentPage].annotations;
      ann.quickLines.push({ x1: state.quickLineStart.x, y1: state.quickLineStart.y, x2: pos.x, y2: pos.y, color: '#e8c547', id: uid() });
      state.quickLineStart = null;
      setTool(TOOL.NONE);
      redraw();
      updateSummary();
      saveToStorage();
    }
    return;
  }

  if (state.tool === TOOL.POLYLINE && state.drawingPolyline) {
    state.drawingPolyline.points.push({ ...pos });
    redraw();
    return;
  }

  if (state.tool === TOOL.COUNTER && state.activeCounterType) {
    const ann = state.pages[state.currentPage].annotations;
    if (!ann.counterMarkers[state.activeCounterType]) ann.counterMarkers[state.activeCounterType] = [];
    ann.counterMarkers[state.activeCounterType].push({ x: pos.x, y: pos.y, id: uid() });
    redraw();
    renderCounterList();
    updateSummary();
    saveToStorage();
    return;
  }
});

annCanvas.addEventListener('dblclick', e => {
  if (state.tool === TOOL.POLYLINE && state.drawingPolyline && state.drawingPolyline.points.length >= 2) {
    finishPolyline(false);
  }
});

annCanvas.addEventListener('contextmenu', e => {
  e.preventDefault();
  const pos = canvasPos(e);

  if (state.tool === TOOL.POLYLINE && state.drawingPolyline && state.drawingPolyline.points.length >= 3) {
    finishPolyline(true);
    return;
  }

  // Check if clicking near an annotation
  const target = hitTest(pos);
  if (target) {
    state.ctxTarget = target;
    const menu = document.getElementById('ctx-menu');
    menu.style.display = 'block';
    menu.style.left = e.clientX + 'px';
    menu.style.top = e.clientY + 'px';
  }
});

document.addEventListener('click', () => {
  document.getElementById('ctx-menu').style.display = 'none';
});

function hitTest(pos, radius = 12) {
  const ann = state.pages[state.currentPage].annotations;
  // Check counter markers
  for (const [typeId, markers] of Object.entries(ann.counterMarkers)) {
    for (let i = 0; i < markers.length; i++) {
      if (ptDist(pos, markers[i]) < radius) return { type: 'marker', typeId, index: i };
    }
  }
  // Check quick line endpoints
  for (let i = 0; i < ann.quickLines.length; i++) {
    const l = ann.quickLines[i];
    const d = distToSegment(pos, {x:l.x1,y:l.y1}, {x:l.x2,y:l.y2});
    if (d < radius) return { type: 'quickLine', index: i };
  }
  // Check polyline points
  for (let pi = 0; pi < ann.polylines.length; pi++) {
    const poly = ann.polylines[pi];
    for (let j = 0; j < poly.points.length - 1; j++) {
      if (distToSegment(pos, poly.points[j], poly.points[j+1]) < radius) return { type: 'polyline', index: pi };
    }
  }
  return null;
}

function distToSegment(p, a, b) {
  const dx = b.x - a.x, dy = b.y - a.y;
  if (dx === 0 && dy === 0) return ptDist(p, a);
  const t = Math.max(0, Math.min(1, ((p.x - a.x) * dx + (p.y - a.y) * dy) / (dx*dx + dy*dy)));
  return ptDist(p, { x: a.x + t*dx, y: a.y + t*dy });
}

function contextDelete() {
  const t = state.ctxTarget;
  if (!t) return;
  const ann = state.pages[state.currentPage].annotations;
  if (t.type === 'marker') {
    ann.counterMarkers[t.typeId].splice(t.index, 1);
  } else if (t.type === 'quickLine') {
    ann.quickLines.splice(t.index, 1);
  } else if (t.type === 'polyline') {
    ann.polylines.splice(t.index, 1);
  }
  state.ctxTarget = null;
  redraw();
  renderCounterList();
  renderPolyList();
  updateSummary();
  saveToStorage();
}

function contextClosePoly() {}

function finishPolyline(closed) {
  if (!state.drawingPolyline || state.drawingPolyline.points.length < 2) return;
  state.drawingPolyline.closed = closed;
  const ann = state.pages[state.currentPage].annotations;
  ann.polylines.push({ ...state.drawingPolyline });
  state.drawingPolyline = null;
  setTool(TOOL.NONE);
  redraw();
  renderPolyList();
  updateSummary();
  saveToStorage();
}

// â”€â”€â”€ TOOL MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTool(tool) {
  state.tool = tool;
  // Clear all active states
  ['btn-scale','btn-line','btn-polyline','btn-counter'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove('active');
  });
  document.getElementById('canvas-area').className = 'canvas-area';
  if (tool === TOOL.SCALE) {
    document.getElementById('btn-scale').classList.add('active');
    document.getElementById('canvas-area').classList.add('mode-scale');
  } else if (tool === TOOL.LINE) {
    document.getElementById('btn-line').classList.add('active');
    document.getElementById('canvas-area').classList.add('mode-line');
  } else if (tool === TOOL.POLYLINE) {
    document.getElementById('btn-polyline').classList.add('active');
    document.getElementById('canvas-area').classList.add('mode-polyline');
  } else if (tool === TOOL.COUNTER) {
    document.getElementById('btn-counter').classList.add('active');
    document.getElementById('canvas-area').classList.add('mode-counter');
  }
  if (tool === TOOL.NONE) { setStatus('No tool active'); hideHUD(); }
}

// â”€â”€â”€ PAGE NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gotoPage(idx) {
  if (idx < 0 || idx >= state.pages.length) return;
  state.currentPage = idx;
  renderCurrentPage();
  renderCounterList();
  renderPolyList();
  updateSummary();
}

function updateNav() {
  const nav = document.getElementById('page-nav');
  if (state.pages.length <= 1) { nav.style.display = 'none'; } else { nav.style.display = 'flex'; }
  document.getElementById('nav-label').textContent = `Page ${state.currentPage + 1} of ${state.pages.length}`;
  document.getElementById('nav-prev').disabled = state.currentPage === 0;
  document.getElementById('nav-next').disabled = state.currentPage === state.pages.length - 1;
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { setTool(TOOL.NONE); state.drawingPolyline = null; state.quickLineStart = null; redraw(); }
  if (e.key === 'ArrowRight' || e.key === 'ArrowDown') gotoPage(state.currentPage + 1);
  if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') gotoPage(state.currentPage - 1);
  if (e.key === 'Enter' && state.tool === TOOL.POLYLINE) finishPolyline(false);
});

// â”€â”€â”€ SIDEBAR RENDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePageList() {
  const list = document.getElementById('page-list');
  list.innerHTML = '';
  state.pages.forEach((p, i) => {
    const hasAnn = hasAnnotations(p.annotations);
    const el = document.createElement('div');
    el.className = 'page-item' + (i === state.currentPage ? ' active' : '');
    el.innerHTML = `<span class="page-num">${i+1}</span><span class="page-name">${p.label}</span>${hasAnn ? '<span class="page-dot"></span>' : ''}`;
    el.onclick = () => gotoPage(i);
    list.appendChild(el);
  });
}

function hasAnnotations(ann) {
  if (ann.quickLines.length > 0 || ann.polylines.length > 0) return true;
  return Object.values(ann.counterMarkers).some(m => m.length > 0);
}

function renderCounterList() {
  const list = document.getElementById('counter-list');
  list.innerHTML = '';
  if (state.counters.length === 0) {
    list.innerHTML = '<div style="padding:10px 12px;font-size:11px;color:var(--text3)">No counters yet</div>';
    return;
  }
  state.counters.forEach(def => {
    const count = (state.pages.length > 0 && state.pages[state.currentPage].annotations.counterMarkers[def.id]) ?
      state.pages[state.currentPage].annotations.counterMarkers[def.id].length : 0;
    const el = document.createElement('div');
    el.className = 'counter-item' + (state.tool === TOOL.COUNTER && state.activeCounterType === def.id ? ' active' : '');
    el.innerHTML = `
      <span class="counter-icon">${def.icon}</span>
      <div class="counter-info"><div class="counter-name">${def.name}</div></div>
      <span class="counter-count">${count}</span>
    `;
    el.onclick = () => activateCounter(def.id);
    list.appendChild(el);
  });
}

function renderPolyList() {
  const list = document.getElementById('poly-list');
  list.innerHTML = '';
  if (state.pages.length === 0) return;
  const ann = state.pages[state.currentPage].annotations;
  const all = [...ann.quickLines.map(l => ({
    name: 'Quick Line',
    color: l.color,
    dist: ptDist({x:l.x1,y:l.y1},{x:l.x2,y:l.y2}),
    id: l.id
  })), ...ann.polylines.map(p => ({
    name: p.name,
    color: p.color,
    dist: polylineDistance(p.points, p.closed),
    id: p.id
  }))];
  if (all.length === 0) {
    list.innerHTML = '<div style="padding:10px 12px;font-size:11px;color:var(--text3)">No lines yet</div>';
    return;
  }
  all.forEach(item => {
    const el = document.createElement('div');
    el.className = 'poly-item';
    el.innerHTML = `
      <div class="poly-swatch" style="background:${item.color}"></div>
      <span class="poly-name">${item.name}</span>
      <span class="poly-dist">${formatDist(item.dist)}</span>
    `;
    list.appendChild(el);
  });
}

// â”€â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSummary() {
  if (state.pages.length === 0) return;
  const section = document.getElementById('summary-section');
  const content = document.getElementById('summary-content');
  const ann = state.pages[state.currentPage].annotations;
  const rows = [];
  state.counters.forEach(def => {
    const count = (ann.counterMarkers[def.id] || []).length;
    if (count > 0) rows.push(`<div class="summary-row"><span>${def.icon} ${def.name}</span><span>${count}</span></div>`);
  });
  const totalDist = [
    ...ann.quickLines.map(l => ptDist({x:l.x1,y:l.y1},{x:l.x2,y:l.y2})),
    ...ann.polylines.map(p => polylineDistance(p.points, p.closed))
  ].reduce((a,b) => a+b, 0);
  if (totalDist > 0) rows.push(`<div class="summary-row"><span>Total Length</span><span>${formatDist(totalDist)}</span></div>`);
  if (rows.length > 0) {
    section.style.display = '';
    content.innerHTML = rows.join('');
  } else { section.style.display = 'none'; }
}

// â”€â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg) {
  document.getElementById('status-mode').textContent = msg;
}

// â”€â”€â”€ MODAL HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// Scale modal live preview
document.getElementById('scale-value').addEventListener('input', () => {
  const val = parseFloat(document.getElementById('scale-value').value);
  const unit = document.getElementById('scale-unit').value;
  const preview = document.getElementById('scale-preview');
  if (state.scalePointA && state.scalePointB && val > 0) {
    const pixels = ptDist(state.scalePointA, state.scalePointB);
    const ppu = (pixels / val) * state.zoom;
    preview.textContent = `1 ${unit} = ${ppu.toFixed(2)} px  (at current zoom)`;
  } else { preview.textContent = 'Enter a value above to preview scale'; }
});

// â”€â”€â”€ FILE UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('file-input').addEventListener('change', async e => {
  const files = Array.from(e.target.files);
  for (const f of files) await loadPDFFile(f);
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('canvas-wrapper').style.display = '';
  // Init counter marker arrays for new pages
  state.counters.forEach(def => {
    state.pages.forEach(p => {
      if (!p.annotations.counterMarkers[def.id]) p.annotations.counterMarkers[def.id] = [];
    });
  });
  state.currentPage = 0;
  fitToView();
  renderCurrentPage();
  renderCounterList();
  updateSummary();
  e.target.value = '';
});

// â”€â”€â”€ CLEAR PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearPage() {
  if (!confirm('Clear all annotations on this page?')) return;
  state.pages[state.currentPage].annotations = makeAnnotations();
  state.counters.forEach(def => {
    state.pages[state.currentPage].annotations.counterMarkers[def.id] = [];
  });
  redraw();
  renderCounterList();
  renderPolyList();
  updateSummary();
  saveToStorage();
}

// â”€â”€â”€ EXPORT / IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportProject() {
  const data = {
    version: 1,
    scale: state.scale,
    counters: state.counters,
    pages: state.pages.map((p, i) => ({
      index: i,
      label: p.label,
      annotations: p.annotations
    }))
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'takeoff-project.json';
  a.click();
}

function importProject(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const data = JSON.parse(ev.target.result);
    if (data.scale) state.scale = data.scale;
    if (data.counters) state.counters = data.counters;
    if (data.pages) {
      data.pages.forEach((pd, i) => {
        if (state.pages[i]) state.pages[i].annotations = pd.annotations;
      });
    }
    if (state.scale) {
      document.getElementById('scale-display').textContent = `Scale: 1 ${state.scale.unit} = ${state.scale.pixelsPerUnit.toFixed(1)} px`;
      document.getElementById('scale-display').style.display = '';
    }
    redraw();
    renderCounterList();
    renderPolyList();
    updateSummary();
    updatePageList();
    saveToStorage();
  };
  reader.readAsText(file);
  e.target.value = '';
}

// â”€â”€â”€ LOCAL STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveToStorage() {
  try {
    const data = {
      scale: state.scale,
      counters: state.counters,
      pageAnnotations: state.pages.map(p => p.annotations)
    };
    localStorage.setItem('takeoff-state', JSON.stringify(data));
  } catch(e) {}
}

// â”€â”€â”€ UID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function uid() { return Math.random().toString(36).slice(2, 10); }

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init() {
  updateZoomLabel();
  renderCounterList();
  renderPolyList();
  // Restore scale from storage
  try {
    const saved = JSON.parse(localStorage.getItem('takeoff-state'));
    if (saved && saved.scale) {
      state.scale = saved.scale;
      document.getElementById('scale-display').textContent = `Scale: 1 ${state.scale.unit} = ${state.scale.pixelsPerUnit.toFixed(1)} px`;
      document.getElementById('scale-display').style.display = '';
    }
    if (saved && saved.counters) state.counters = saved.counters;
  } catch(e) {}
})();
</script>
</body>
</html>
